var e=Object.defineProperty,t=Object.prototype.hasOwnProperty,s=Object.getOwnPropertySymbols,a=Object.prototype.propertyIsEnumerable,r=(t,s,a)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a,i=(e,i)=>{for(var n in i||(i={}))t.call(i,n)&&r(e,n,i[n]);if(s)for(var n of s(i))a.call(i,n)&&r(e,n,i[n]);return e};import{g as n,eb as o,q as c,gk as d,r as u,aZ as l,dH as h,ch as p,bk as I}from"./vendor.1ee57f36.js";import{G as _}from"./aaBoundingBox.960884d4.js";import{i as g}from"./rbush.d43ba1fa.js";const f=import("./labelFormatUtils.d74264b8.js");class b{constructor(e,t){this._canCacheExpressionValue=!1,this._sourceInfo=e,this._bitsets={computed:t.getBitset(t.createBitset())}}async updateSchema(e,t){const s=o(this._schema,t);if(this._schema=t,!t||c(s)||!d(s,"attributes"))return;u("esri-2d-update-debug")&&console.debug("Applying Update - Store:",s),this._bitsets.computed.clear(),e.targets[t.name]=!0;const a=t.attributes,r=[],i=[];for(const n in a){const e=a[n];switch(e.type){case"field":break;case"expression":r.push(this._createArcadeComputedField(e));break;case"label-expression":r.push(this._createLabelArcadeComputedField(e));break;case"statistic":i.push(e)}}this._computedFields=await l(r),this._canCacheExpressionValue=!this._computedFields.some((e=>"expression"===e.type&&e.expression.referencesScale())),this._statisticFields=i}setComputedAttributes(e,t,s,a){const r=this._bitsets.computed;if(!this._canCacheExpressionValue||!r.has(s)){r.set(s);for(const r of this._computedFields){const i=this._evaluateField(t,r,a);switch(r.resultType){case"numeric":e.setComputedNumericAtIndex(s,r.fieldIndex,i);break;case"string":e.setComputedStringAtIndex(s,r.fieldIndex,i)}}}}async _createArcadeComputedField(e){const t=this._sourceInfo.spatialReference,s=this._sourceInfo.fieldsIndex;return i(i({},e),{expression:await h(e.valueExpression,t,s)})}async _createLabelArcadeComputedField(e){const t=this._sourceInfo.spatialReference,s=this._sourceInfo.fields,{createLabelFunction:a}=await f,r=await a(e.label,s,t);return i(i({},e),{builder:r})}_evaluateField(e,t,s){switch(t.type){case"label-expression":{const s=e.readArcadeFeature();return t.builder.evaluate(s)||""}case"expression":{const{expression:a}=t;return function(e,t,s){e.referencesGeometry();const a=t.readArcadeFeature();try{return e.evaluate(i(i({},s),{$feature:a}))}catch(r){return n.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",r),null}}(a,e,{$view:{scale:s}})}}}}function y(e){return(4294901760&e)>>>16}function m(e){return 65535&e}const x={getObjectId:e=>e.getObjectId(),getAttributes:e=>e.readAttributes(),getAttribute:(e,t)=>e.readAttribute(t),cloneWithGeometry:(e,t)=>e,getGeometry:e=>e.readHydratedGeometry(),getCentroid:(e,t)=>e.readCentroid()};class F extends b{constructor(e,t){super(e,t),this.featureAdapter=x,this.events=new p,this._featureSetsByInstance=new Map,this._objectIdToDisplayId=new Map,this._spatialIndexInvalid=!0,this._index=g(9,(e=>({minX:this._storage.getXMin(e),minY:this._storage.getYMin(e),maxX:this._storage.getXMax(e),maxY:this._storage.getYMax(e)})))}get storeStatistics(){return{featureCount:0,vertexCount:0}}onTileData(e,t,s){if(c(t.addOrUpdate))return t;this._featureSetsByInstance.set(t.addOrUpdate.instance,t.addOrUpdate),this._storage=s,t.addOrUpdate._storage=s;const a=t.addOrUpdate.getCursor();for(;a.next();){const t=a.getObjectId(),r=a.instance<<16|a.getIndex();let i=this._objectIdToDisplayId.get(t);i||(i=s.createDisplayId(),this._objectIdToDisplayId.set(t,i),this._spatialIndexInvalid=!0),a.setDisplayId(i),s.setInstanceId(i,r),this.setComputedAttributes(s,a,i,e.scale)}return"update"===t.type&&(this._spatialIndexInvalid=!0),this.events.emit("changed"),t}forEach(e){this._objectIdToDisplayId.forEach((t=>{const s=this._storage.getInstanceId(t),a=this._lookupFeature(s);e(a)}))}forEachUnsafe(e){this._objectIdToDisplayId.forEach((t=>{const s=this._storage.getInstanceId(t),a=y(s),r=m(s),i=this._getFeatureSet(a);i.setIndex(r),e(i)}))}forEachInBounds(e,t){const s=this._searchIndex(e);for(const a of s){const e=this.lookupFeatureByDisplayId(a,this._storage);t(I(e))}}forEachBounds(e,t,s){this._rebuildIndex();const a=[0,0,0,0];for(const r of e){if(!r.readGeometry())continue;const e=r.getDisplayId();a[0]=this._storage.getXMin(e),a[1]=this._storage.getYMin(e),a[2]=this._storage.getXMax(e),a[3]=this._storage.getYMax(e),t(_(s,a))}}sweepFeatures(e,t,s){this._objectIdToDisplayId.forEach(((a,r)=>{e.has(a)||(t.releaseDisplayId(a),s.unsetAttributeData(a),this._objectIdToDisplayId.delete(r))})),this.events.emit("changed")}sweepFeatureSets(e){this._featureSetsByInstance.forEach(((t,s)=>{e.has(s)||this._featureSetsByInstance.delete(s)}))}lookupObjectId(e,t){const s=this.lookupFeatureByDisplayId(e,t);return c(s)?null:s.getObjectId()}lookupDisplayId(e){return this._objectIdToDisplayId.get(e)}lookupFeatureByDisplayId(e,t){const s=t.getInstanceId(e);return this._lookupFeature(s)}lookupByDisplayIdUnsafe(e){const t=this._storage.getInstanceId(e),s=y(t),a=m(t),r=this._getFeatureSet(s);return r?(r.setIndex(a),r):null}hasInstance(e){return this._featureSetsByInstance.has(e)}_rebuildIndex(){if(!this._spatialIndexInvalid)return;this._index.clear();const e=[];this._objectIdToDisplayId.forEach((t=>{const s=this._storage.getInstanceId(t);this._storage.setBounds(t,this._lookupFeature(s))&&e.push(t)})),this._index.load(e),this._spatialIndexInvalid=!1}_lookupFeature(e){const t=y(e),s=m(e),a=this._getFeatureSet(t);if(!a)return null;const r=a.getCursor();return r.setIndex(s),r}_getFeatureSet(e){return this._featureSetsByInstance.get(e)}_searchIndex(e){this._rebuildIndex();const t={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]};return this._index.search(t)}}export{x as d,b as n,F as u};
