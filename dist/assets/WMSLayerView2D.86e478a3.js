var e=Object.defineProperty,t=Object.prototype.hasOwnProperty,r=Object.getOwnPropertySymbols,a=Object.prototype.propertyIsEnumerable,i=(t,r,a)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[r]=a;import{e as s,y as o,i as n,O as p,m as h,U as m,g as d,fq as l,c4 as c,z as u}from"./vendor.1ee57f36.js";import{y}from"./ExportWMSImageParameters.146dbd70.js";import{l as g,p as f}from"./LayerView2D.5b971eca.js";import{t as w}from"./BitmapContainer.5579ad62.js";import{w as x}from"./ExportStrategy.9f412349.js";import"./Container.c19388ee.js";import"./mat4f32.65c405e6.js";import"./Utils.88967ee0.js";import"./WGLContainer.df898e6a.js";import"./ShaderCompiler.00c23a07.js";import"./Program.76c009ec.js";import"./GeometryUtils.4f6b8486.js";import"./MaterialKey.464cac5a.js";import"./earcut.4e65dd4c.js";import"./Bitmap.979d0e7e.js";const v=e=>{let t=class extends e{async fetchPopupFeatures(e){const{layer:t}=this;if(!e)return p(new h("wmslayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:t}));const{popupEnabled:r}=t;if(!r)return p(new h("wmslayerview:fetchPopupFeatures","popupEnabled should be true",{popupEnabled:r}));const a=this.createFetchPopupFeaturesQuery(e),{extent:i,width:s,height:o,x:n,y:d}=a;if(!(i&&s&&o))throw new h("wmslayerview:fetchPopupFeatures","WMSLayer does not support fetching features.",{extent:i,width:s,height:o});const l=t.fetchFeatureInfo(i,s,o,n,d);return l?l.then((e=>[e])):m([])}};return s([o()],t.prototype,"layer",void 0),t=s([n("esri.layers.mixins.WMSLayerView")],t),t},b=d.getLogger("esri.views.2d.layers.WMSLayerView2D");let S=class extends(v(l(g(f)))){initialize(){const{layer:e,view:t}=this;e.supportsSpatialReference(t.spatialReference)||this.addResolvingPromise(p(new h("layerview:spatial-reference-incompatible","The spatial references supported by this WMS layer are incompatible with the spatial reference of the view",{layer:e})))}hitTest(){return null}update(e){this.strategy.update(e).catch((e=>{c(e)||b.error(e)}))}attach(){const{layer:e,view:t}=this,{imageMaxHeight:r,imageMaxWidth:a}=e;this._bitmapContainer=new w,this.container.addChild(this._bitmapContainer),this.strategy=new x({container:this._bitmapContainer,fetchSource:this.fetchImage.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxHeight:r,imageMaxWidth:a,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1}),this._exportWMSImageParameters=new y({layer:e,view:t}),this.handles.add(this._exportWMSImageParameters.watch("version",(e=>{this._exportImageVersion!==e&&(this._exportImageVersion=e,this.requestUpdate())})),"wms")}detach(){this.handles.remove("wms"),this.strategy.destroy(),this._exportWMSImageParameters.layer=null,this._exportWMSImageParameters.destroy(),this._exportWMSImageParameters=null,this.container.removeChild(this._bitmapContainer),this._bitmapContainer.removeAllChildren()}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}createFetchPopupFeaturesQuery(e){const{view:t}=this,r=this._bitmapContainer,{x:a,y:i}=e,{spatialReference:s}=t;let o=null,n=0,p=0;r.children.some((e=>{const{width:t,height:r,resolution:h,x:m,y:d}=e,l=m+h*t,c=d-h*r;return a>=m&&a<=l&&i<=d&&i>=c&&(o=new u({xmin:m,ymin:c,xmax:l,ymax:d,spatialReference:s}),n=t,p=r,!0)}));const h=o.width/n,m=Math.round((a-o.xmin)/h),d=Math.round((o.ymax-i)/h);return{extent:o,width:n,height:p,x:m,y:d}}async doRefresh(){this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}fetchImage(e,s,o,n){return this.layer.fetchImage(e,s,o,((e,s)=>{for(var o in s||(s={}))t.call(s,o)&&i(e,o,s[o]);if(r)for(var o of r(s))a.call(s,o)&&i(e,o,s[o]);return e})({timeExtent:this._exportWMSImageParameters.timeExtent,timestamp:this.refreshTimestamp},n))}};s([o()],S.prototype,"strategy",void 0),s([o({dependsOn:["strategy.updating"]})],S.prototype,"updating",void 0),S=s([n("esri.views.2d.layers.WMSLayerView2D")],S);var j=S;export default j;
