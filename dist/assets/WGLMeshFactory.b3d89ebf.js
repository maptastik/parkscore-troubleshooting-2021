var t=Object.defineProperty,e=Object.prototype.hasOwnProperty,s=Object.getOwnPropertySymbols,i=Object.prototype.propertyIsEnumerable,r=(e,s,i)=>s in e?t(e,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[s]=i,n=(t,n)=>{for(var o in n||(n={}))e.call(n,o)&&r(t,o,n[o]);if(s)for(var o of s(n))i.call(n,o)&&r(t,o,n[o]);return t};import{m as o,dF as a,g as l,aZ as h,dG as c,dH as u,dI as f,dJ as d,k as m,dK as _,dL as p,q as y,bk as x,aJ as g,cM as M,dA as w,b2 as b,b3 as v,dw as T,b1 as L,c6 as C,bP as P,b4 as S,c9 as z,c3 as I,dB as k,dM as R,bW as A,cW as F,O,U as D,dN as G,dO as V,dP as B,c0 as E,dd as K,de as W,dc as Z,c4 as X,bT as H,dQ as j,dx as U,dR as N,dS as q,c5 as Y}from"./vendor.1ee57f36.js";import{r as Q}from"./index.4894e768.js";import{N as J,s as $,j as tt}from"./cimAnalyzer.a961a551.js";import{E as et,w as st,m as it,S as rt,Z as nt,a as ot}from"./Utils.88967ee0.js";import{S as at,c as lt,T as ht,z as ct,y as ut,E as ft,e as dt,m as mt}from"./MaterialKey.464cac5a.js";import{v as _t,T as pt,s as yt,a as xt,r as gt,n as Mt,b as wt,c as bt,o as vt}from"./shapingUtils.66b0bc31.js";import{e as Tt,r as Lt,d as Ct,f as Pt}from"./VertexBuffer.19222be6.js";import{f as St,i as zt}from"./CircularArray.1d7faf48.js";import{s as It,n as kt,r as Rt,E as At,a as Ft,i as Ot,u as Dt,o as Gt,b as Vt,c as Bt}from"./TurboLine.6302d753.js";import{A as Et,o as Kt,G as Wt,p as Zt,r as Xt}from"./CIMSymbolHelper.2ecfa4b9.js";import{h as Ht,M as jt}from"./GeometryUtils.4f6b8486.js";function Ut(t,e){if(t&&"name"in t){const s=t;return e&&e.error(new o(s.name,s.message,s.details)),!1}return!0}const Nt={marker:et.MARKER,fill:et.FILL,line:et.LINE,text:et.TEXT};class qt{constructor(t,e,s){this.layers=t,this.data=e,this.hash=this._createHash(),this.rendererKey=s;for(const i of t){const t=Nt[i.type];i.materialKey=at(t,this.rendererKey,!1,!1)}}get type(){return"expanded-cim"}_createHash(){let t="";for(const e of this.layers)t+=e.templateHash;return t}}const Yt=async(t,e)=>new qt(await J(t.data,e),t.data,t.rendererKey),Qt=async(t,e,s)=>{if(!t)return null;if("cim"===t.type)return Yt(t,e);if("web-style"===t.type){const i=a.fromJSON(t),r={type:"cim",data:(await i.fetchCIMSymbol(s)).data,rendererKey:t.rendererKey};return Yt(r,e)}return t},Jt=l.getLogger("esri/views/2d/engine/webgl/util/Matcher");class $t{constructor(){this.type="feature",this._defaultResult=null}static async fromBasicRenderer(t,e,s){const i=new $t;if(t.symbol){const r=await Qt(t.symbol,s),n=e.createTemplateGroup(r,null);i.setDefault(n)}return i}size(){return 1}getDefault(){return this._defaultResult}setDefault(t){this._defaultResult=t}match(t,e,s,i,r){return this.getDefault()}async analyze(t,e,s,i,r){return null}}class te extends $t{constructor(t,e,s,i){super(),this.type="interval",this._intervals=[],this._isMaxInclusive=e,this._fieldIndex=i,this._field=t,this._normalizationInfo=s}static async fromCBRenderer(t,e,s){const{isMaxInclusive:i,normalizationField:r,normalizationTotal:n,normalizationType:o}=t,a=t.field,l=new te(a,i,{normalizationField:r,normalizationTotal:n,normalizationType:o},t.fieldIndex),c=await Qt(t.backgroundFillSymbol,s);await h(t.intervals.map((async t=>{const i=await Qt(t.symbol,s),r=await e.createTemplateGroup(i,c),n={min:t.min,max:t.max};l.add(n,r)})));const u=await Qt(t.defaultSymbol,s);if(u){const t=await e.createTemplateGroup(u,c);l.setDefault(t)}return l}add(t,e){this._intervals.push({interval:t,result:e}),this._intervals.sort(((t,e)=>t.interval.min-e.interval.min))}size(){return super.size()+this._intervals.length}match(t,e,s,i,r){if(null==this._fieldIndex&&!this._field)return this.getDefault();const n=null!=this._fieldIndex?e.getComputedNumericAtIndex(this._fieldIndex):this._getValueFromField(e);if(!n&&(null==n||isNaN(n)))return this.getDefault();for(let o=0;o<this._intervals.length;o++){const{interval:t,result:e}=this._intervals[o],s=n>=t.min,i=this._isMaxInclusive?n<=t.max:n<t.max;if(s&&i)return e}return this.getDefault()}_needsNormalization(){const t=this._normalizationInfo;return t&&(t.normalizationField||t.normalizationTotal||t.normalizationType)}_getValueFromField(t){const e=t.readAttribute(this._field);if(!this._needsNormalization())return e;const{normalizationField:s,normalizationTotal:i,normalizationType:r}=this._normalizationInfo,n=!!s&&t.readAttribute(s);if(r)switch(r){case"esriNormalizeByField":return n?e/n:void 0;case"esriNormalizeByLog":return Math.log(e)*Math.LOG10E;case"esriNormalizeByPercentOfTotal":return e/i*100;default:return void Jt.error(`Found unknown normalization type: ${r}`)}else Jt.error("Normalization is required, but no type was set!")}}class ee extends $t{constructor(t,e,s){super(),this.type="map",this._nullResult=null,this._resultsMap=new Map,this._fieldsIndex=s,this._fields=t,this._seperator=e||""}static async fromUVRenderer(t,e,s){const i=t.fieldDelimiter,r=[t.field];t.field2&&r.push(t.field2),t.field3&&r.push(t.field3);const n=await Qt(t.backgroundFillSymbol,s),o=new ee(r,i,t.fieldIndex);await h(t.map.map((async t=>{const i=await Qt(t.symbol,s),r=await e.createTemplateGroup(i,n);"<Null>"===t.value?o.setNullResult(r):o.add(t.value,r)})));const a=await Qt(t.defaultSymbol,s);if(a){const t=await e.createTemplateGroup(a,n);o.setDefault(t)}return o}setNullResult(t){this._nullResult=t}add(t,e){this._resultsMap.set(t.toString(),e)}size(){return super.size()+this._resultsMap.size}match(t,e,s,i,r){if(null==this._fieldsIndex&&!this._fields)return this.getDefault();const n=null!=this._fieldsIndex?e.getComputedStringAtIndex(this._fieldsIndex):this._getValueFromFields(e);if(null!==this._nullResult&&(null==n||""===n||"<Null>"===n))return this._nullResult;if(!n&&null==n)return this.getDefault();const o=n.toString();return this._resultsMap.has(o)?this._resultsMap.get(o):this.getDefault()}_getValueFromFields(t){const e=[];for(const s of this._fields){const i=t.readAttribute(s);e.push(i)}return e.join(this._seperator)}}class se extends $t{constructor(t,e,s,i){super(),this.type="dictionary",this._groupIdCache=new c(100),this._renderer=t,this._fieldMap=t.fieldMap,this._symbolFields=t.getSymbolFields(),this._templates=e,this._info=s,this._scaleFn=i}static async fromDictionaryRenderer(t,e,s){const i=(await import("./vendor.1ee57f36.js").then((function(t){return t.jQ}))).default.fromJSON(t.renderer);await i.fetchResources({spatialReference:s.spatialReference,fields:s.fields});const r=await async function(t,e){const s=t||1;if("number"==typeof s)return(t,e,i)=>s;const i=await u(s,e.spatialReference,e.fields);return(t,s,r)=>$(i,t,{$view:r},e.geometryType,s)||1}(i.scaleExpression,s);return new se(i,e,s,r)}async _analyzeFeature(t,e,s,i){const r=t.readLegacyFeature(),a=this._scaleFn(r,e,s),l=this._attributeHash(r)+"-"+a,h=this._groupIdCache.get(l);if(h)return h;const c=n(n({},s),{spatialReference:this._info.spatialReference,abortOptions:i,fields:this._info.fields}),u=await this._renderer.getSymbolAsync(r,c),f=_t(u,this._renderer),d=Qt(f,this._info,i).then((t=>{if("expanded-cim"!==t.type)return Jt.error(new o("mapview-bad-type",`Found unexpected type ${t.type} in dictionary response`)),null;t.hash+="-"+a;for(const e of t.layers)e.scaleFactor=a,e.templateHash+="-"+a,"text"===e.type&&"string"==typeof e.text&&e.text.indexOf("[")>-1&&(e.text=Q(this._fieldMap,e.text,e.cim.textCase));return this._templates.createTemplateGroup(t,null)}));return this._groupIdCache.put(l,d,1),d}async analyze(t,e,s,i,r){const n=e.getCursor(),o=[];for(;n.next();)o.push(this._analyzeFeature(n,s,i,r));return h(o)}match(t,e,s,i,r){return null}_attributeHash(t){let e="";for(const s of this._symbolFields){const i=this._fieldMap[s];i&&(e+=t.attributes[i]+"-")}return e}}const ie=l.getLogger("esri/views/2d/engine/webgl/mesh/factories/matcherUtils");async function re(t,e,s){switch(t.type){case"simple":return $t.fromBasicRenderer(t,e,s);case"map":return ee.fromUVRenderer(t,e,s);case"interval":return te.fromCBRenderer(t,e,s);case"dictionary":return se.fromDictionaryRenderer(t,e,s);default:return ie.error(new o("mapview-mesh:invalid-renderer","Unable to handle unknown renderer type")),null}}class ne{static getPlacement(t,e,s){const i=Et(e);if(!i)return null;const r=Kt(t);return i.execute(r,e,s)}}var oe=t=>class extends t{constructor(...t){super(...t),this._isCIM=!1,this.geometryType=et.TEXT,this._aux=st(0,0,this._referenceSize,this._bitset)}bindTextInfo(t,e){t&&t.length?this._shapingInfo=f(t,(t=>pt(t,e,{scale:this._scale,angle:this._angle,xOffset:this._xOffset,yOffset:this._yOffset,hAlign:this._xAlignD,vAlign:this._yAlignD,maxLineWidth:Math.max(32,Math.min(this._lineWidth,512)),lineHeight:d*Math.max(.25,Math.min(this._lineHeight,4)),decoration:this._decoration,isCIM:this._isCIM}))):this._shapingInfo=null}writeMeshWithGeometry(t,e,s,i,r,n){if(m(this._textPlacement)){const i=null!=n?n:s.readLegacyGeometry();return this._writePlacedText(t,e,r,i)}const o=n?_(p(n),2):"esriGeometryPolygon"===i?s.readCentroid():s.readUnquantizedGeometry();if(o){if(o.isPoint){const[s,i]=o.coords;return this._writeGlyphs(t,e,r,{x:s,y:i})}o.forEachVertex(((s,i)=>this._writeGlyphs(t,e,r,{x:s,y:i})))}}_writePlacedText(t,e,s,i){const r=this._shapingInfo;if(y(r))return;const n=lt.load(this._materialKey),o=x(this._textPlacement),a=ne.getPlacement(i,o,g(1));if(!a)return;let l,h,c=a.next();for(;null!=c;){h=it(Math.round(8*c.tx),Math.round(8*c.ty)),l=c.getAngle(),r.setRotation(l);for(const i of r.glyphs){n.textureBinding=i.textureBinding;const r=e.getVector("geometry").vertexCount,o=e.indexVector.length,a=this._writeIndices(e),l=this._writeVertex(e,s,h,i);t.writeDisplayRecord(this.geometryType,n.data,r,l,o,a)}r.setRotation(-l),c=a.next()}}_writeGlyphs(t,e,s,i){const r=this._shapingInfo;if(y(r))return;const n=lt.load(this._materialKey),o=it(Math.round(8*i.x),Math.round(8*i.y));for(const a of r.glyphs){n.textureBinding=a.textureBinding;const i=e.getVector("geometry").vertexCount,r=e.indexVector.length,l=this._writeIndices(e),h=this._writeVertex(e,s,o,a);t.writeDisplayRecord(this.geometryType,n.data,i,h,r,l)}}_writeVertexCommon(t,e,s,i){const r=this._color,n=this._haloColor,o=st(0,0,this._referenceSize,this._bitset),a=st(0,0,this._size,this._haloSize);t.push(s),t.push(e),t.push(r),t.push(n),t.push(a),t.push(o)}_writeVertex(t,e,s,i){const r=t.get("geometry");return this._writeVertexCommon(r,e,s,i),r.push(i.offsets.upperLeft),r.push(i.texcoords.upperLeft),this._writeVertexCommon(r,e,s,i),r.push(i.offsets.upperRight),r.push(i.texcoords.upperRight),this._writeVertexCommon(r,e,s,i),r.push(i.offsets.lowerLeft),r.push(i.texcoords.lowerLeft),this._writeVertexCommon(r,e,s,i),r.push(i.offsets.lowerRight),r.push(i.texcoords.lowerRight),4}_writeIndices(t){const e=t.getVector("geometry").vertexCount,s=t.indexVector;return s.push(e+0),s.push(e+1),s.push(e+2),s.push(e+1),s.push(e+3),s.push(e+2),6}};class ae{static executeEffects(t,e){const s=Kt(e);let i=new Xt(s);for(const r of t){const t=Wt(r);t&&(i=t.execute(i,r,1.3333333333333333))}return i}static next(t){const e=t.next();return Zt(e),e}}class le{get needsPixelBuffer(){return!!this.effects||this.geometryType===et.MARKER||this.geometryType===et.TEXT||this.geometryType===et.LABEL}writeMesh(t,e,s,i,r){if(y(this.effects))return this.writeMeshWithGeometry(t,e,s,i,r);const n=ae.executeEffects(this.effects,s.readLegacyGeometry());let o=ae.next(n);for(;o;)this.writeMeshWithGeometry(t,e,s,M(o),r,o),o=ae.next(n)}writeMeshWithGeometry(t,e,s,i,r,n){}bindFeature(t,e,s){}}class he extends(oe(le)){constructor(t,e,s,i,r,n,o,a,l,h,c,u,f,d,m,_,p,y=!1){super(),this._xOffset=g(u),this._yOffset=g(f),this._decoration=l||"none",this._color=i,this._haloColor=r,this._haloSize=Math.min(Math.floor(5*g(w(s))),127),this._size=Math.min(Math.round(g(e)),127);const x=Math.min(Math.round(g(e)),127);this._referenceSize=Math.round(Math.sqrt(256*x)),this._scale=this._size/24,this._angle=c,this._justify=yt(n||"center"),this._xAlignD=xt(n||"center"),this._yAlignD=gt(o||"baseline"),this._baseline="baseline"===(o||"baseline"),this._bitset=(1===a?1:0)|(h?1:0)<<1;const M=lt.load(t);M.sdf=!0,this._materialKey=M.data,this._lineWidth=g(d)||512,this._lineHeight=m||1,this._textPlacement=_,this.effects=p,this._isCIM=y}static fromText(t,e){const s=new he(t.materialKey,t.font.size,t.haloSize||0,t.color&&St(t.color)||0,t.haloColor&&St(t.haloColor)||0,t.horizontalAlignment,t.verticalAlignment,0,t.font.decoration,!1,t.angle||0,t.xoffset,t.yoffset,t.lineWidth,t.lineHeight,null,null,!1),[,i]=Mt(t.text);return s.bindTextInfo(e,i),s}static fromCIMText(t,e){const s=t.scaleFactor||1,i=new he(t.materialKey,t.size*t.sizeRatio*s,t.outlineSize*t.sizeRatio,zt(t.color),zt(t.outlineColor),t.horizontalAlignment,t.verticalAlignment,t.alignment,t.decoration,t.colorLocked,t.angle,t.offsetX*t.sizeRatio*s,t.offsetY*t.sizeRatio*s,512,1,t.markerPlacement,t.effects,!0),[,r]=Mt(t.text);return i.bindTextInfo(e,r),i}}var ce=t=>class extends t{constructor(...t){super(...t),this.angle=0,this.xOffset=0,this.yOffset=0,this.width=0,this.height=0,this.boundsType="square",this._anchorX=0,this._anchorY=0,this._computedWidth=0,this._computedHeight=0,this.geometryType=et.MARKER}writeMeshWithGeometry(t,e,s,i,r,n){const o=e.indexVector,a=e.get("geometry"),l=e.getVector("geometry"),h=l.vertexCount,c=h,u=o.length;if(m(this._markerPlacement)){const t=null!=n?n:s.readLegacyGeometry();this._writePlacedMarkers(a,o,h,r,t)}else{const t=n?_(p(n),2):"esriGeometryPolygon"===i?s.readCentroid():s.readUnquantizedGeometry();if(!t)return;if(t.isPoint){const[e,s]=t.coords;this._writeVertices(a,r,this._getPos(e,s)),this._writeIndices(o,h)}else t.forEachVertex(((t,e)=>{const s=l.vertexCount;this._writeVertices(a,r,this._getPos(t,e)),this._writeIndices(o,s)}))}const f=e.getVector("geometry").vertexCount-c,d=o.length-u;t.writeDisplayRecord(this.geometryType,this._materialKey,c,f,u,d)}_applyTransformation(t,e,s=0){b(t),v(t,t,T(this.xOffset,-this.yOffset)),this.angle+s!==0&&L(t,t,.017453292519944444*(this.angle+s));const i=this._computedWidth,r=this._computedHeight,n=(this._anchorX-.5)*i,o=(this._anchorY-.5)*r;C(e,n,o),P(e,e,t),this._offsetUpperLeft=it(16*e[0],16*e[1]),C(e,n+i,o),P(e,e,t),this._offsetUpperRight=it(16*e[0],16*e[1]),C(e,n,o+r),P(e,e,t),this._offsetBottomLeft=it(16*e[0],16*e[1]),C(e,n+i,o+r),P(e,e,t),this._offsetBottomRight=it(16*e[0],16*e[1])}_writePlacedMarkers(t,e,s,i,r){const n=ne.getPlacement(r,x(this._markerPlacement),g(1));if(!n)return;const o=z(),a=S();let l=0,h=n.next();for(;null!=h;)h.tx>=-128&&h.tx<=640&&h.ty>=-128&&h.ty<=640&&(this._applyTransformation(a,o,h.getAngle()/.017453292519944444),this._writeVertices(t,i,this._getPos(h.tx,h.ty)),this._writeIndices(e,s+l),l+=4),h=n.next()}_getPos(t,e){return it(Math.round(8*t),Math.round(8*e))}_writeVertices(t,e,s){t.push(s),t.push(this._offsetUpperLeft),t.push(this._texUpperLeft),t.push(this._bitestAndDistRatio),t.push(e),t.push(this._fillColor),t.push(this._outlineColor),t.push(this._sizeOutlineWidth),t.push(s),t.push(this._offsetUpperRight),t.push(this._texUpperRight),t.push(this._bitestAndDistRatio),t.push(e),t.push(this._fillColor),t.push(this._outlineColor),t.push(this._sizeOutlineWidth),t.push(s),t.push(this._offsetBottomLeft),t.push(this._texBottomLeft),t.push(this._bitestAndDistRatio),t.push(e),t.push(this._fillColor),t.push(this._outlineColor),t.push(this._sizeOutlineWidth),t.push(s),t.push(this._offsetBottomRight),t.push(this._texBottomRight),t.push(this._bitestAndDistRatio),t.push(e),t.push(this._fillColor),t.push(this._outlineColor),t.push(this._sizeOutlineWidth)}_writeIndices(t,e){const s=e;t.push(s+0),t.push(s+1),t.push(s+2),t.push(s+1),t.push(s+3),t.push(s+2)}};class ue extends(ce(le)){constructor(t,e,s,i,r,n,o,a,l,h,c,u,f,d,m,_,p,y,x,g,M){super(),this.angle=i,this.height=o,this.width=n,this.xOffset=e*x,this.yOffset=s*x,this._markerPlacement=g,this.effects=M,this._anchorX=.5-(.5+_)*m.width/m.width,this._anchorY=.5-(.5+p)*m.height/m.height;const w=(1===d?1:0)|(c?1:0)<<1|(f?1:0)<<2|(u?1:0)<<3,b=m&&m.sdf,v=ht.load(t);v.sdf=b,v.pattern=!0,v.textureBinding=m.textureBinding,this._materialKey=v.data,this._fillColor=r,this._outlineColor=l,this._sizeOutlineWidth=st(Math.round(Math.min(Math.sqrt(128*n),255)),Math.round(Math.min(Math.sqrt(128*o),255)),Math.round(Math.min(Math.sqrt(128*h),255)),Math.round(Math.min(Math.sqrt(128*a),255)));const T=m.rect.x+I,L=m.rect.y+I,C=T+m.width,P=L+m.height;this._texUpperLeft=it(T,L),this._texUpperRight=it(C,L),this._texBottomLeft=it(T,P),this._texBottomRight=it(C,P),n*=y,o*=y,n*=x,o*=x;const k=Math.round(Math.min(64*y,255));this._bitestAndDistRatio=st(0,0,w,k),this._computedWidth=n,this._computedHeight=o;const R=z(),A=S();this._applyTransformation(A,R)}static fromCIMMarker(t,e){const s=e&&e.width||1,i=e&&e.height||1,r=t.size,n=s/i*t.scaleX,o=t.scaleSymbolsProportionally&&t.frameHeight?r/t.frameHeight:1,a=zt(t.color),l=zt(t.outlineColor),h=g(r),c=h*n,u=g(t.offsetX||0),f=g(t.offsetY||0),d=g(t.outlineWidth||0)*o,m=t.alignment||0,_=g(t.referenceSize);let p=t.rotation||0;t.rotateClockwise||(p=-p);let y=0,x=0;const M=t.anchorPoint;return M&&(t.isAbsoluteAnchorPoint?r&&(y=-M.x/(r*n),x=M.y/r):(y=M.x,x=M.y)),new ue(t.materialKey,u,f,p,a,c,h,_,l,d,t.colorLocked,t.scaleSymbolsProportionally,!1,m,e,y,x,t.sizeRatio,k(t.scaleFactor,1),t.markerPlacement,t.effects)}static fromPictureMarker(t,e){const s=Math.round(g(t.width)),i=Math.round(g(t.height)),r=R,n=Math.round(g(t.xoffset||0)),o=Math.round(g(t.yoffset||0));return new ue(t.materialKey,n,o,t.angle,r,s,i,i,0,0,!1,!1,!1,0,e,0,0,1,1,null,null)}static fromSimpleMarker(t,e){const s=St(t.color),i=Math.round(g(t.size)),r=i,n=Math.round(g(t.xoffset||0)),o=Math.round(g(t.yoffset||0)),a=t.style,l=t.outline,h=0|(l&&l.color&&St(l.color)),c=0|(l&&l.width&&Math.round(g(l.width))),u=new ue(t.materialKey,n,o,t.angle,s,i,r,r,h,c,!1,!1,"esriSMSCross"===a||"esriSMSX"===a,0,e,0,0,126/64,1,null,null);return u.boundsType="esriSMSCircle"===a?"circle":"square",u}static fromLineSymbolMarker(t,e){const s=St(t.color),i=Math.round(g(6*t.lineWidth)),r=i,n="cross"===t.style||"x"===t.style;let o;switch(t.placement){case"begin-end":o="Both";break;case"begin":o="JustBegin";break;case"end":o="JustEnd";break;default:o="None"}const a={type:"CIMMarkerPlacementAtExtremities",angleToLine:!0,offset:0,extremityPlacement:o,offsetAlongLine:0},l=new ue(t.materialKey,0,0,0,s,i,r,r/6,s,n?Math.round(g(t.lineWidth)):0,!1,!1,n,1,e,0,0,126/64,1,a,null);return l.boundsType="circle"===t.style?"circle":"square",l}}function fe(t,e,s,i,r,n,o){De=0;const a=(i-s)*n,l=r&&r.length,h=l?(r[0]-s)*n:a;let c,u,f,d,m,_=de(e,s,i,0,h,n,!0);if(_&&_.next!==_.prev){if(l&&(_=function(t,e,s,i,r,n){const o=new Array;for(let a=0,l=i.length;a<l;a++){const r=de(t,e,s,i[a]*n,a<l-1?i[a+1]*n:s*n,n,!1);r===r.next&&(r.steiner=!0),o.push(Me(r))}o.sort(ze);for(const a of o)we(a,r),r=me(r,r.next);return r}(e,s,i,r,_,n)),a>80*n){c=f=e[0+s*n],u=d=e[1+s*n];for(let t=n;t<h;t+=n){const i=e[t+s*n],r=e[t+1+s*n];c=Math.min(c,i),u=Math.min(u,r),f=Math.max(f,i),d=Math.max(d,r)}m=Math.max(f-c,d-u),m=0!==m?1/m:0}_e(_,t,n,c,u,m,o,0)}}function de(t,e,s,i,r,n,o){let a;if(o===function(t,e,s,i,r,n){let o=0;for(let a=i,l=r-n;a<r;a+=n)o+=(t[l+e*n]-t[a+e*n])*(t[a+1+e*n]+t[l+1+e*n]),l=a;return o}(t,e,0,i,r,n)>0)for(let l=i;l<r;l+=n)a=xe(l+e*n,t[l+e*n],t[l+1+e*n],a);else for(let l=r-n;l>=i;l-=n)a=xe(l+e*n,t[l+e*n],t[l+1+e*n],a);return a&&Se(a,a.next)&&(ge(a),a=a.next),a}function me(t,e=t){if(!t)return t;let s,i=t;do{if(s=!1,i.steiner||!Se(i,i.next)&&0!==ve(i.prev,i,i.next))i=i.next;else{if(ge(i),i=e=i.prev,i===i.next)break;s=!0}}while(s||i!==e);return e}function _e(t,e,s,i,r,n,o,a){if(!t)return;!a&&n&&(t=be(t,i,r,n));let l=t;for(;t.prev!==t.next;){const h=t.prev,c=t.next;if(n?ye(t,i,r,n):pe(t))e.push(h.index/s+o),e.push(t.index/s+o),e.push(c.index/s+o),ge(t),t=c.next,l=c.next;else if((t=c)===l){a?1===a?_e(t=Ie(t,e,s,o),e,s,i,r,n,o,2):2===a&&ke(t,e,s,i,r,n,o):_e(me(t),e,s,i,r,n,o,1);break}}}function pe(t){const e=t.prev,s=t,i=t.next;if(ve(e,s,i)>=0)return!1;let r=t.next.next;const n=r;let o=0;for(;r!==t.prev&&(0===o||r!==n);){if(o++,Le(e.x,e.y,s.x,s.y,i.x,i.y,r.x,r.y)&&ve(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function ye(t,e,s,i){const r=t.prev,n=t,o=t.next;if(ve(r,n,o)>=0)return!1;const a=r.x<n.x?r.x<o.x?r.x:o.x:n.x<o.x?n.x:o.x,l=r.y<n.y?r.y<o.y?r.y:o.y:n.y<o.y?n.y:o.y,h=r.x>n.x?r.x>o.x?r.x:o.x:n.x>o.x?n.x:o.x,c=r.y>n.y?r.y>o.y?r.y:o.y:n.y>o.y?n.y:o.y,u=Pe(a,l,e,s,i),f=Pe(h,c,e,s,i);let d=t.prevZ,m=t.nextZ;for(;d&&d.z>=u&&m&&m.z<=f;){if(d!==t.prev&&d!==t.next&&Le(r.x,r.y,n.x,n.y,o.x,o.y,d.x,d.y)&&ve(d.prev,d,d.next)>=0)return!1;if(d=d.prevZ,m!==t.prev&&m!==t.next&&Le(r.x,r.y,n.x,n.y,o.x,o.y,m.x,m.y)&&ve(m.prev,m,m.next)>=0)return!1;m=m.nextZ}for(;d&&d.z>=u;){if(d!==t.prev&&d!==t.next&&Le(r.x,r.y,n.x,n.y,o.x,o.y,d.x,d.y)&&ve(d.prev,d,d.next)>=0)return!1;d=d.prevZ}for(;m&&m.z<=f;){if(m!==t.prev&&m!==t.next&&Le(r.x,r.y,n.x,n.y,o.x,o.y,m.x,m.y)&&ve(m.prev,m,m.next)>=0)return!1;m=m.nextZ}return!0}function xe(t,e,s,i){const r=Fe.create(t,e,s);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function ge(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Me(t){let e=t,s=t;do{(e.x<s.x||e.x===s.x&&e.y<s.y)&&(s=e),e=e.next}while(e!==t);return s}function we(t,e){if(e=function(t,e){let s=e;const i=t.x,r=t.y;let n,o=-1/0;do{if(r<=s.y&&r>=s.next.y&&s.next.y!==s.y){const t=s.x+(r-s.y)*(s.next.x-s.x)/(s.next.y-s.y);if(t<=i&&t>o){if(o=t,t===i){if(r===s.y)return s;if(r===s.next.y)return s.next}n=s.x<s.next.x?s:s.next}}s=s.next}while(s!==e);if(!n)return null;if(i===o)return n.prev;const a=n,l=n.x,h=n.y;let c,u=1/0;for(s=n.next;s!==a;)i>=s.x&&s.x>=l&&i!==s.x&&Le(r<h?i:o,r,l,h,r<h?o:i,r,s.x,s.y)&&(c=Math.abs(r-s.y)/(i-s.x),(c<u||c===u&&s.x>n.x)&&Ce(s,t)&&(n=s,u=c)),s=s.next;return n}(t,e)){const s=Ae(e,t);me(s,s.next)}}function be(t,e,s,i){for(let r;r!==t;r=r.next){if(r=r||t,null===r.z&&(r.z=Pe(r.x,r.y,e,s,i)),r.prev.next!==r||r.next.prev!==r)return r.prev.next=r,r.next.prev=r,be(t,e,s,i);r.prevZ=r.prev,r.nextZ=r.next}return t.prevZ.nextZ=null,t.prevZ=null,function(t){let e,s=1;for(;;){let i,r=t;t=null,e=null;let n=0;for(;r;){n++,i=r;let o=0;for(;o<s&&i;o++)i=i.nextZ;let a=s;for(;o>0||a>0&&i;){let s;0===o?(s=i,i=i.nextZ,a--):0!==a&&i?r.z<=i.z?(s=r,r=r.nextZ,o--):(s=i,i=i.nextZ,a--):(s=r,r=r.nextZ,o--),e?e.nextZ=s:t=s,s.prevZ=e,e=s}r=i}if(e.nextZ=null,s*=2,n<2)return t}}(t)}function ve(t,e,s){return(e.y-t.y)*(s.x-e.x)-(e.x-t.x)*(s.y-e.y)}function Te(t,e,s,i){return!!(Se(t,e)&&Se(s,i)||Se(t,i)&&Se(s,e))||ve(t,e,s)>0!=ve(t,e,i)>0&&ve(s,i,t)>0!=ve(s,i,e)>0}function Le(t,e,s,i,r,n,o,a){return(r-o)*(e-a)-(t-o)*(n-a)>=0&&(t-o)*(i-a)-(s-o)*(e-a)>=0&&(s-o)*(n-a)-(r-o)*(i-a)>=0}function Ce(t,e){return ve(t.prev,t,t.next)<0?ve(t,e,t.next)>=0&&ve(t,t.prev,e)>=0:ve(t,e,t.prev)<0||ve(t,t.next,e)<0}function Pe(t,e,s,i,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-s)*r)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)*r)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function Se(t,e){return t.x===e.x&&t.y===e.y}function ze(t,e){return t.x-e.x}function Ie(t,e,s,i){let r=t;do{const n=r.prev,o=r.next.next;!Se(n,o)&&Te(n,r,r.next,o)&&Ce(n,o)&&Ce(o,n)&&(e.push(n.index/s+i),e.push(r.index/s+i),e.push(o.index/s+i),ge(r),ge(r.next),r=t=o),r=r.next}while(r!==t);return r}function ke(t,e,s,i,r,n,o){let a=t;do{let t=a.next.next;for(;t!==a.prev;){if(a.index!==t.index&&Re(a,t)){let l=Ae(a,t);return a=me(a,a.next),l=me(l,l.next),_e(a,e,s,i,r,n,o,0),void _e(l,e,s,i,r,n,o,0)}t=t.next}a=a.next}while(a!==t)}function Re(t,e){return t.next.index!==e.index&&t.prev.index!==e.index&&!function(t,e){let s=t;do{if(s.index!==t.index&&s.next.index!==t.index&&s.index!==e.index&&s.next.index!==e.index&&Te(s,s.next,t,e))return!0;s=s.next}while(s!==t);return!1}(t,e)&&Ce(t,e)&&Ce(e,t)&&function(t,e){let s=t,i=!1;const r=(t.x+e.x)/2,n=(t.y+e.y)/2;do{s.y>n!=s.next.y>n&&s.next.y!==s.y&&r<(s.next.x-s.x)*(n-s.y)/(s.next.y-s.y)+s.x&&(i=!i),s=s.next}while(s!==t);return i}(t,e)}function Ae(t,e){const s=Fe.create(t.index,t.x,t.y),i=Fe.create(e.index,e.x,e.y),r=t.next,n=e.prev;return t.next=e,e.prev=t,s.next=r,r.prev=s,i.next=s,s.prev=i,n.next=i,i.prev=n,i}class Fe{constructor(){this.index=0,this.x=0,this.y=0,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}static create(t,e,s){const i=Oe[De++];return i.index=t,i.x=e,i.y=s,i.prev=null,i.next=null,i.z=null,i.prevZ=null,i.nextZ=null,i.steiner=!1,i}}const Oe=new Array;let De=0;for(let Is=0;Is<8096;Is++)Oe.push(new Fe);const Ge=new It,Ve=new kt(0,0,0,1,128);function Be(t,e,s){let i=0;for(let r=1;r<s;r++){const s=t[2*(e+r-1)],n=t[2*(e+r-1)+1];i+=(t[2*(e+r)]-s)*(t[2*(e+r)+1]+n)}return i}function Ee(t,e,s,i,r){let n=0;for(let o=s;o<i;o+=3){const s=2*(t.getValue(o)-r),i=2*(t.getValue(o+1)-r),a=2*(t.getValue(o+2)-r);n+=Math.abs((e[s]-e[a])*(e[i+1]-e[s+1])-(e[s]-e[i])*(e[a+1]-e[s+1]))}return n}Ve.setExtent(A);var Ke=t=>class extends t{constructor(...t){super(...t),this.forceLibtess=!1,this.geometryType=et.FILL}writeMeshWithGeometry(t,e,s,i,r,n){const o=ct.load(this._materialKey),a=e.indexVector,l=e.getVector("geometry"),h=l.vertexCount,c=a.length;let u=n?_(p(n),2):s.readUnquantizedGeometry();if(!u)return;if(u=function(t){if(!function(t,e,s){let i=0;for(let r=0;r<t.lengths.length;r++){const e=t.lengths[r];for(let r=0;r<e;r++){const e=t.coords[2*(r+i)],n=t.coords[2*(r+i)+1];if(e<-128||e>s||n<-128||n>s)return!0}i+=e}return!1}(t,0,A+128))return t;Ve.reset(3);let e=0;for(let n=0;n<t.lengths.length;n++){const s=t.lengths[n];let i=t.coords[2*(0+e)],r=t.coords[2*(0+e)+1];Ve.moveTo(i,r);for(let n=1;n<s;n++)i=t.coords[2*(n+e)],r=t.coords[2*(n+e)+1],Ve.lineTo(i,r);Ve.close(),e+=s}const s=Ve.result(!1);if(!s)return null;const i=[],r=[];for(const n of s){let t=0;for(const e of n)r.push(e.x),r.push(e.y),t++;i.push(t)}return new F(i,r)}(u),!u)return;let f=u.coords;!this.forceLibtess&&function(t,e,s){const{coords:i,lengths:r,hasIndeterminateRingOrder:n}=e;if(n)return!1;const o=t.length;let a=0;for(let l=0;l<r.length;){let e=l,n=r[l],h=Be(i,a,n);const c=[];for(;++e<r.length;){const t=r[e],s=Be(i,a+n,t);if(!(s>0))break;h+=s,c.push(a+n),n+=t}const u=t.length;fe(t,i,a,a+n,c,2,s);const f=Ee(t,i,u,t.length,s),d=Math.abs(h);if(Math.abs((f-d)/Math.max(1e-7,d))>1e-5)return t.seek(o),!1;l=e,a+=n}return!0}(a,u,h)||(f=[],function(t,e,s,i){const r=[],{coords:n,lengths:o}=s;Ge.beginPolygon(t,r);let a=0;for(let l=0;l<o.length;l++){const t=s.lengths[l];Ge.beginContour();for(let e=0;e<t;e++){const t=[n[2*(a+e)],n[2*(a+e)+1],0];Ge.addVertex(t,t)}Ge.endContour(),a+=t}Ge.endPolygon();for(let l=0;l<r.length;l++)e.push(r[l]+i)}(f,a,u,h)),this._write(l,s,r,f,o);const d=l.vertexCount-h,m=a.length-c;t.writeDisplayRecord(this.geometryType,this._materialKey,h,d,c,m)}_write(t,e,s,i,r){for(let n=0;n<i.length;n+=2){const o=it(1*i[n],1*i[n+1]);t.data.push(o),t.data.push(s),r.dotDensity?t.data.writeF32(1/Math.abs(e.readGeometryArea())):(t.data.push(this.fillColor),t.data.push(this.tl),t.data.push(this.br),t.data.push(this.aux1),t.data.push(this.aux2),t.data.push(this.aux3))}}};const We=l.getLogger("esri.views.2d.engine.webgl.WGLDynamicMeshTemplate");class Ze extends le{constructor(t){super(),this._ongoingMaterialRequestMap=new Map,this._materialCache=new Map,this._dynamicPropertyMap=new Map,this._cimLayer=t}analyze(t,e,s,i){const r=e.readLegacyFeature(),n=this._materialCache,o=this._cimLayer.materialHash;if(!o)return We.error("A Dynamic mesh template must have a material hash value or function!"),O(null);const a="function"==typeof o?o(r,s,i):o;if(n.has(a)){const t=n.get(a);return D(t)}if(this._ongoingMaterialRequestMap.has(a))return this._ongoingMaterialRequestMap.get(a);const l=tt(this._cimLayer.cim,this._cimLayer.materialOverrides);l.mosaicHash=a;const h=t.getMosaicItem(l).then((t=>(this._ongoingMaterialRequestMap.delete(a),n.set(a,t),t))).catch((t=>(this._ongoingMaterialRequestMap.delete(a),We.error(".analyze()",t.message),null)));return this._ongoingMaterialRequestMap.set(a,h),h}}class Xe extends(Ke(Ze)){constructor(t){if(super(t),Rt(t.color)){const e=(e,s,i)=>{const r=t.color(e,s,i);return r&&zt(r)||0};this._dynamicPropertyMap.set("_fillColor",e)}else{const e=t.color;this.fillColor=e&&zt(e)||0}let e=0;Rt(t.height)||(e=t.height||0),this._dynamicPropertyMap.set("_height",((s,i,r)=>Rt(t.height)?t.height(s,i,r):e));let s=0;Rt(t.offsetX)||(s=g(t.offsetX||0)+128,s>255&&(s=255)),this._dynamicPropertyMap.set("_offsetX",((e,i,r)=>{if(Rt(t.offsetX)){let s=g(t.offsetX(e,i,r))+128;return s>255&&(s=255),s}return s}));let i=1;Rt(t.scaleX)||(i=t.scaleX||1),this._dynamicPropertyMap.set("_scaleX",((e,s,r)=>Rt(t.scaleX)?t.scaleX(e,s,r):i));let r=0;Rt(t.offsetY)||(r=g(-t.offsetY||0)+128,r>255&&(r=255)),this._dynamicPropertyMap.set("_offsetY",((e,s,i)=>{if(Rt(t.offsetY)){let r=g(-t.offsetY(e,s,i))+128;return r>255&&(r=255),r}return r}));let n=0;Rt(t.angle)||(n=Ht(t.angle)||0),this._dynamicPropertyMap.set("_angle",((e,s,i)=>Rt(t.angle)?Ht(t.angle(e,s,i)):n)),this.effects=t.effects,this._cimFillLayer=t,this._fillMaterialKey=ct.load(t.materialKey)}static fromCIMFill(t){return new Xe(t)}bindFeature(t,e,s){const i=t.readLegacyFeature();this._dynamicPropertyMap.forEach(((t,r)=>{this[r]=t(i,e,s)}));const r=this._fillMaterialKey,n=this._materialCache,o=this._cimFillLayer;this.aux3=st(0,0,this._angle,o.colorLocked?1:0);const a=(0,o.materialHash)(i,e,s),l=n.get(a);let h=null;if(l&&Ut(l.spriteMosaicItem)&&(h=l.spriteMosaicItem),h){const{rect:t,width:e,height:s}=h,i=t.x+I,n=t.y+I,o=i+e,a=n+s;let l=G(g(this._height));l>255?l=255:l<=0&&(l=G(a-n));let c=G(g(this._height/s*e||0));c>255?c=255:c<=0&&(c=G(o-i));const u=this._scaleX,f=1;this.tl=it(i,n),this.br=it(o,a),this.aux1=st(c,l,this._offsetX,this._offsetY),this.aux2=it(128*u,128*f),r.sdf=h.sdf,r.pattern=!0,r.textureBinding=h.textureBinding}else this.tl=0,this.br=0,this.aux1=0,this.aux2=0,r.sdf=!1,r.pattern=!1,r.textureBinding=0;this._materialKey=r.data}}const He=A+16,je=new kt(0,0,0,1,16);je.setExtent(A);const Ue=new Uint32Array(9),Ne=new Uint32Array(36),qe=new Uint32Array(3),Ye=new Uint32Array(6),Qe=t=>e=>{Ye[0]=e.leftExit0,Ye[1]=e.rightEntry0,Ye[2]=e.leftExit2,Ye[3]=e.rightEntry0,Ye[4]=e.rightEntry2,Ye[5]=e.leftExit2,t.indexCount+=6,t.indexBuf.writeRegion(Ye)};var Je=t=>class extends t{constructor(...t){super(...t),this.tessellationProperties={_fillColor:null,_tl:null,_br:null,_halfWidth:null,_bitset:null,_halfReferenceWidth:null,id:null,indexBuf:null,indexCount:null,geometryBuf:null,vertexCount:null,offset:null},this._tessellationOptions={},this.geometryType=et.LINE}writeMeshWithGeometry(t,e,s,i,r,n){const o=e.indexVector,a=e.get("geometry"),l=e.getVector("geometry").vertexCount,h=o.length,c=null!=n?n:s.readLegacyGeometry();if(!c)return;switch(i){case"esriGeometryPolyline":{const t=this._clipLines(c.paths);if(0===t.length)return;this._write(o,a,l,r,t);break}case"esriGeometryPolygon":{const t=this._clipLines(c.rings);if(0===t.length)return;this._write(o,a,l,r,t);break}}const u=this.tessellationProperties.vertexCount,f=this.tessellationProperties.indexCount;t.writeDisplayRecord(this.geometryType,this._materialKey,l,u,h,f)}_clipLines(t){const e=[];let s=!1,i=0;for(;i<t.length;){const r=[],n=t[i];je.reset(2);let[o,a]=n[0];if(s)je.moveTo(o,a);else{if(o<-16||o>He||a<-16||a>He){s=!0;continue}r.push({x:o,y:a})}let l=!1;const h=n.length;for(let t=1;t<h;++t)if(o+=n[t][0],a+=n[t][1],s)je.lineTo(o,a);else{if(o<-16||o>He||a<-16||a>He){l=!0;break}r.push({x:o,y:a})}if(l)s=!0;else{if(s){const t=je.resultWithStarts();if(t)for(const s of t)e.push(s)}else e.push({line:r,start:0});i++,s=!1}}return e}_write(t,e,s,i,r){this.tessellationProperties.id=i,this.tessellationProperties.indexBuf=t,this.tessellationProperties.indexCount=0,this.tessellationProperties.geometryBuf=e,this.tessellationProperties.vertexCount=0,this.tessellationProperties.offset=s;for(const n of r){const t=n.line;t.length<2||(this._tessellationOptions.initialDistance=n.start%65535,this._tessellationCallbacks instanceof At&&(this._tessellationCallbacks.capType=this._capType,this._tessellationCallbacks.joinType=this._joinType),Ft(t,this._tessellationOptions,this._tessellationCallbacks),Ot())}}_initializeTessellator(t){const e=ut.load(this._materialKey);if(this._tessellationOptions.trackDistance=this._isDashed||this._hasPattern,this._tessellationOptions.thin=!t&&this.tessellationProperties._halfWidth<V/2&&!(e.vvSizeFieldStops||e.vvSizeMinMaxValue||e.vvSizeScaleStops||e.vvSizeUnitValue),this._tessellationOptions.wrapDistance=65535,this._tessellationOptions.outerBisectorAutoSplitThreshold=.2631578947368421,this._tessellationOptions.enableOuterBisectorSplit=this._isDashed||this._hasPattern,this._tessellationOptions.innerBisectorAutoSplitThreshold=.2631578947368421,this._tessellationOptions.enableInnerBisectorSplit=this._isDashed||this._hasPattern,this._tessellationOptions.thin)this._tessellationCallbacks={vertex:(s=this.tessellationProperties,t=>{const e=Math.ceil(1024*s._halfWidth),i=Math.ceil(1024*s._halfReferenceWidth);t.entry0=s.offset+s.vertexCount++;{const r=it(t.distance,e),n=st(Math.round(31*t.prevNormal.x),Math.round(31*t.prevNormal.y),Math.round(0),Math.round(-31)),o=st(0,0,0,s._bitset);Ne[0]=it(8*t.currentVertex.x,8*t.currentVertex.y),Ne[1]=s.id,Ne[2]=s._fillColor,Ne[3]=n,Ne[4]=r,Ne[5]=s._tl,Ne[6]=s._br,Ne[7]=o,Ne[8]=it(i,0)}t.entry2=s.offset+s.vertexCount++;{const r=it(t.distance,e),n=st(Math.round(31*-t.prevNormal.x),Math.round(31*-t.prevNormal.y),Math.round(0),Math.round(31)),o=st(0,0,0,s._bitset);Ne[9]=it(8*t.currentVertex.x,8*t.currentVertex.y),Ne[10]=s.id,Ne[11]=s._fillColor,Ne[12]=n,Ne[13]=r,Ne[14]=s._tl,Ne[15]=s._br,Ne[16]=o,Ne[17]=it(i,0)}t.exit0=s.offset+s.vertexCount++;{const r=it(t.distance,e),n=st(Math.round(31*t.nextNormal.x),Math.round(31*t.nextNormal.y),Math.round(0),Math.round(-31)),o=st(0,0,0,s._bitset);Ne[18]=it(8*t.currentVertex.x,8*t.currentVertex.y),Ne[19]=s.id,Ne[20]=s._fillColor,Ne[21]=n,Ne[22]=r,Ne[23]=s._tl,Ne[24]=s._br,Ne[25]=o,Ne[26]=it(i,0)}t.exit2=s.offset+s.vertexCount++;{const r=it(t.distance,e),n=st(Math.round(31*-t.nextNormal.x),Math.round(31*-t.nextNormal.y),Math.round(0),Math.round(31)),o=st(0,0,0,s._bitset);Ne[27]=it(8*t.currentVertex.x,8*t.currentVertex.y),Ne[28]=s.id,Ne[29]=s._fillColor,Ne[30]=n,Ne[31]=r,Ne[32]=s._tl,Ne[33]=s._br,Ne[34]=o,Ne[35]=it(i,0)}s.geometryBuf.writeRegion(Ne)}),bridge:Qe(this.tessellationProperties)};else{const t=new At((t=>(e,s,i,r,n,o,a,l,h)=>{const c=it(h,Math.ceil(1024*t._halfWidth)),u=st(Math.round(31*n),Math.round(31*o),Math.round(31*a),Math.round(31*l)),f=st(31*i,31*r,0,t._bitset);return Ue[0]=it(8*e,8*s),Ue[1]=t.id,Ue[2]=t._fillColor,Ue[3]=u,Ue[4]=c,Ue[5]=t._tl,Ue[6]=t._br,Ue[7]=f,Ue[8]=it(Math.ceil(1024*t._halfReferenceWidth),0),t.geometryBuf.writeRegion(Ue),t.offset+t.vertexCount++})(this.tessellationProperties),(t=>(e,s,i)=>{qe[0]=e,qe[1]=s,qe[2]=i,t.indexCount+=3,t.indexBuf.writeRegion(qe)})(this.tessellationProperties));t.miterLimitCosine=this._miterLimitCosine,t.textured=this._isDashed||this._hasPattern,t.joinOnUTurn=this._joinOnUTurn,this._tessellationCallbacks=t}var s}};class $e extends(Je(Ze)){constructor(t){super(t),this._cimLineLayer=t;let e=0;if(Rt(t.width)||(e=.5*g(t.width)),this._dynamicPropertyMap.set("_halfWidth",((s,i,r)=>Rt(t.width)?.5*g(t.width(s,i,r)):e)),Rt(t.cap)?this._dynamicPropertyMap.set("_capType",t.cap):this._capType=t.cap,Rt(t.join)?this._dynamicPropertyMap.set("_joinType",t.join):this._joinType=t.join,Rt(t.color)){const e=(e,s,i)=>{const r=t.color(e,s,i);return r&&zt(r)||0};this._dynamicPropertyMap.set("_fillColor",e)}else{const e=t.color;this._fillColor=e&&zt(e)||0}if(Rt(t.miterLimit)){const e=(e,s,i)=>Dt(t.miterLimit(e,s,i));this._dynamicPropertyMap.set("_miterLimitCosine",e)}else this._miterLimitCosine=Dt(t.miterLimit);this._scaleFactor=t.scaleFactor||1,this._isDashed=t.isDashed,this.effects=t.effects,this.tessellationProperties._bitset=t.colorLocked?1:0,this._materialKey=t.materialKey,this._initializeTessellator(!0)}static fromCIMLine(t){return new $e(t)}bindFeature(t,e,s){const i=t.readLegacyFeature();this._dynamicPropertyMap.forEach(((t,r)=>{this[r]=t(i,e,s)})),this._halfWidth*=this._scaleFactor;const r=this._materialCache,n=(0,this._cimLineLayer.materialHash)(i,e,s),o=r.get(n);let a=null;if(o&&Ut(o.spriteMosaicItem)&&(a=o.spriteMosaicItem),a){this._hasPattern=!0;const{rect:t,width:e,height:s}=a,i=t.x+I,r=t.y+I,n=i+e,o=r+s;this.tessellationProperties._tl=it(i,r),this.tessellationProperties._br=it(n,o)}else this._hasPattern=!1,this.tessellationProperties._tl=0,this.tessellationProperties._br=0;this.tessellationProperties._fillColor=this._fillColor,this.tessellationProperties._halfWidth=this._halfWidth,this.tessellationProperties._halfReferenceWidth=this.tessellationProperties._halfWidth;const l=ut.load(this._materialKey);a&&(l.sdf=a.sdf,l.pattern=!0,l.textureBinding=a.textureBinding),this._materialKey=l.data}}const ts=z(),es=S(),ss=l.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate");class is extends(ce(Ze)){constructor(t){if(super(t),this._cimMarkerLayer=t,Rt(t.color)){const e=(e,s,i)=>zt(t.color(e,s,i));this._dynamicPropertyMap.set("_fillColor",e)}else this._fillColor=zt(t.color);if(Rt(t.outlineColor)){const e=(e,s,i)=>zt(t.outlineColor(e,s,i));this._dynamicPropertyMap.set("_outlineColor",e)}else this._outlineColor=zt(t.outlineColor);if(Rt(t.size)){const e=(e,s,i)=>g(t.size(e,s,i));this._dynamicPropertyMap.set("_size",e)}else this._size=g(t.size);if(Rt(t.scaleX)?this._dynamicPropertyMap.set("_scaleX",t.scaleX):this._scaleX=t.scaleX,Rt(t.offsetX)){const e=(e,s,i)=>g(t.offsetX(e,s,i));this._dynamicPropertyMap.set("xOffset",e)}else this.xOffset=g(t.offsetX);if(Rt(t.offsetY)){const e=(e,s,i)=>g(t.offsetY(e,s,i));this._dynamicPropertyMap.set("yOffset",e)}else this.yOffset=g(t.offsetY);if(Rt(t.outlineWidth)){const e=(e,s,i)=>g(t.outlineWidth(e,s,i));this._dynamicPropertyMap.set("_outlineWidth",e)}else this._outlineWidth=g(t.outlineWidth);Rt(t.rotation)?this._dynamicPropertyMap.set("_angle",t.rotation):this._angle=t.rotation,this._scaleFactor=k(t.scaleFactor,1),this._markerPlacement=t.markerPlacement,this.effects=t.effects,this._bitSet=(1===t.alignment?1:0)|(t.colorLocked?1:0)<<1|(t.scaleSymbolsProportionally?1:0)<<3,this._materialKey=t.materialKey}static fromCIMMarker(t){return new is(t)}bindFeature(t,e,s){const i=t.readLegacyFeature();this._dynamicPropertyMap.forEach(((t,r)=>{this[r]=t(i,e,s)}));const r=this._cimMarkerLayer.materialHash,n="function"==typeof r?r(i,e,s):r,a=this._materialCache.get(n);if(!a||!Ut(a.spriteMosaicItem)||!a.spriteMosaicItem)return void ss.error(new o("mapview-cim","Encountered an error when binding feature"));const l=a.spriteMosaicItem,h=this._cimMarkerLayer.sizeRatio,c=l.width/l.height*this._scaleX,u=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle;let f=this._size,d=f*c;const m=this.xOffset,_=this.yOffset;this.xOffset*=this._scaleFactor,this.yOffset*=this._scaleFactor;const p=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?this._size/g(this._cimMarkerLayer.frameHeight):1,y=this._outlineWidth*p,x=g(this._cimMarkerLayer.referenceSize);let M=0,w=0;const b=this._cimMarkerLayer.anchorPoint;b&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?this._size&&(M=-b.x/(this._size*c),w=b.y/this._size):(M=b.x,w=b.y)),this._sizeOutlineWidth=st(Math.round(Math.min(Math.sqrt(128*d),255)),Math.round(Math.min(Math.sqrt(128*f),255)),Math.round(Math.min(Math.sqrt(128*y),255)),Math.round(Math.min(Math.sqrt(128*x),255))),this.angle=u;const v=Math.round(Math.min(64*h,255));this._bitestAndDistRatio=st(0,0,this._bitSet,v);const T=l.rect.x+I,L=l.rect.y+I,C=T+l.width,P=L+l.height;this._texUpperLeft=it(T,L),this._texUpperRight=it(C,L),this._texBottomLeft=it(T,P),this._texBottomRight=it(C,P);const S=ht.load(this._materialKey);S.sdf=l.sdf,S.pattern=!0,S.textureBinding=l.textureBinding,this._materialKey=S.data,this._anchorX=.5-(.5+M)*l.width/l.width,this._anchorY=.5-(.5+w)*l.height/l.height,d*=h,f*=h,d*=this._scaleFactor,f*=this._scaleFactor,d*=l.rect.width/l.width,f*=l.rect.height/l.height,this._computedWidth=d,this._computedHeight=f,this._applyTransformation(es,ts),this.xOffset=m,this.yOffset=_}}function rs(t){const e=new Array(t.length);for(let s=0;s<t.length;s++)e[s]=t.charCodeAt(s);return e}class ns extends(oe(Ze)){constructor(t){super(t),this._horizontalAlignment="center",this._verticalAlignment="middle",this._textToGlyphs=new Map;const e=t.scaleFactor||1;if(this._cimTextLayer=t,Rt(t.color)){const e=(e,s,i)=>zt(t.color(e,s,i));this._dynamicPropertyMap.set("_color",e)}else this._color=zt(t.color);if(Rt(t.color)){const e=(e,s,i)=>zt(t.outlineColor(e,s,i));this._dynamicPropertyMap.set("_haloColor",e)}else this._haloColor=zt(t.outlineColor);let s,i,r;if(Rt(t.size)||(s=Math.min(Math.round(g(t.size*t.sizeRatio)),127)),this._dynamicPropertyMap.set("_size",((e,i,r)=>Rt(t.size)?Math.min(Math.round(g(t.size(e,i,r)*t.sizeRatio)),127):s)),Rt(t.outlineSize)){const e=(e,s,i)=>Math.min(Math.floor(5*g(t.outlineSize(e,s,i)*t.sizeRatio)),127);this._dynamicPropertyMap.set("_haloSize",e)}else this._haloSize=Math.min(Math.floor(5*g(t.outlineSize*t.sizeRatio)),127);Rt(t.offsetX)||(i=Math.round(g(t.offsetX*t.sizeRatio))),this._dynamicPropertyMap.set("_xOffset",((e,s,r)=>Rt(t.offsetX)?Math.round(g(t.offsetX(e,s,r)*t.sizeRatio)):i)),Rt(t.offsetY)||(r=Math.round(g(t.offsetY*t.sizeRatio))),this._dynamicPropertyMap.set("_yOffset",((e,s,i)=>Rt(t.offsetY)?Math.round(g(t.offsetY(e,s,i)*t.sizeRatio)):r)),Rt(t.angle)?this._dynamicPropertyMap.set("_angle",t.angle):this._angle=t.angle,Rt(t.horizontalAlignment)?this._dynamicPropertyMap.set("_horizontalAlignment",t.horizontalAlignment):this._horizontalAlignment=t.horizontalAlignment,Rt(t.verticalAlignment)?this._dynamicPropertyMap.set("_verticalAlignment",t.verticalAlignment):this._verticalAlignment=t.verticalAlignment,this._scaleFactor=e,Rt(t.text)?this._dynamicPropertyMap.set("_text",t.text):this._text=t.text;const n=Math.min(Math.round(g(t.referenceSize*t.sizeRatio)),127);this._referenceSize=Math.round(Math.sqrt(256*n)),this._materialKey=t.materialKey;const o=ft.load(this._materialKey);o.sdf=!0,this._bitset=(1===t.alignment?1:0)|(t.colorLocked?1:0)<<1,this._materialKey=o.data,this._decoration="none",this._lineHeight=1,this._lineWidth=512,this._textPlacement=t.markerPlacement,this.effects=t.effects,this._isCIM=!0}static fromCIMText(t){return new ns(t)}async analyze(t,e,s,i){const r=e.readLegacyFeature(),n=(a=this._cimTextLayer,l=r,h=s,c=i,"string"==typeof a.text?a.text:"function"==typeof a.text?a.text(l,h,c):""),o=await t.getMosaicItem(this._cimTextLayer.cim,rs(n));var a,l,h,c;return this._textToGlyphs.set(n,o.glyphMosaicItems),o}bindFeature(t,e,s){const i=t.readLegacyFeature();if(this._dynamicPropertyMap.forEach(((t,r)=>{this[r]=t(i,e,s)})),!this._text||0===this._text.length)return void(this._shapingInfo=null);this._size*=this._scaleFactor,this._scale=this._size/24,this._xOffset*=this._scaleFactor,this._yOffset*=this._scaleFactor,this._xAlignD=xt(this._horizontalAlignment||"center"),this._yAlignD=gt(this._verticalAlignment||"baseline");const r=this._textToGlyphs.get(this._text);this.bindTextInfo(r,!1)}}class os extends(Ke(le)){constructor(t,e,s,i,r,n,o,a,l){super(),this.effects=l;const h=ct.load(t);e&&(h.sdf=e.sdf,h.pattern=!0,h.textureBinding=e.textureBinding),this.fillColor=s,this.tl=i,this.br=r,this.aux1=n,this.aux2=o,this.aux3=a,this._materialKey=h.data}static fromCIMFill(t,e){const s=t.color,i=s&&zt(s)||0,r=t.materialKey;if(!e){const e=st(0,0,0,t.colorLocked?1:0);return new os(r,null,i,0,0,0,0,e,t.effects)}const{rect:n,width:o,height:a}=e,l=n.x+I,h=n.y+I,c=l+o,u=h+a;let f=G(g(t.height||0));f>255?f=255:f<=0&&(f=G(u-h));let d=G(g(t.height/a*o||0));d>255?d=255:d<=0&&(d=G(c-l));let m=g(t.offsetX||0)+128;m>255&&(m=255);let _=g(-t.offsetY||0)+128;_>255&&(_=255);const p=t.scaleX||1,y=it(l,h),x=it(c,u),M=st(d,f,m,_),w=it(128*p,128),b=st(0,0,jt(t.angle),t.colorLocked?1:0);return new os(r,e,i,y,x,M,w,b,t.effects)}static fromSimpleFill(t,e,s=!1){const{color:i}=t,r=i&&"esriSFSNull"!==t.style&&St(i)||0,n=st(0,0,0,s?255:0),o=t.materialKey;if(!e)return new os(o,null,r,0,0,0,0,n,null);const{rect:a,width:l,height:h}=e,c=a.x+I,u=a.y+I,f=c+l,d=u+h,m=it(c,u),_=it(f,d),p=st(G(f-c),G(d-u),0,0),y=it(128,128);return new os(o,e,r,m,_,p,y,n,null)}static fromPictureFill(t,e,s=!1){const i=R,{rect:r,width:n,height:o}=e,a=r.x+I,l=r.y+I,h=a+n,c=l+o,u=it(a,l),f=it(h,c);let d=G(g(t.width));d>255&&(d=255);let m=G(g(t.height));m>255&&(m=255);let _=g(t.xoffset)+128;_>255&&(_=255);let p=g(-t.yoffset)+128;p>255&&(p=255);const y=st(d,m,_,p),x=it(128*t.xscale,128*t.yscale),M=st(0,0,0,s?255:0),w=t.materialKey;return new os(w,e,i,u,f,y,x,M,null)}}const as=l.getLogger("esri.views.2d.engine.webgl.WGLLineTemplate");class ls extends(Je(le)){constructor(t,e,s,i,r,n,o,a,l,h,c,u,f,d,m,_){super();const p=ut.load(t);e&&(p.sdf=e.sdf,p.pattern=!0,p.textureBinding=e.textureBinding),this._capType=i,this._joinType=r,this._miterLimitCosine=Dt(n),this.tessellationProperties._fillColor=o,this.tessellationProperties._tl=a,this.tessellationProperties._br=l,this._hasPattern=h,this._isDashed=c,this._joinOnUTurn=m,this._isColorLocked=u,this._zOrder=d,this.effects=_,this._materialKey=p.data,this.tessellationProperties._bitset=u?1:0,this.tessellationProperties._halfWidth=.5*s,this.tessellationProperties._halfReferenceWidth=.5*f,this._initializeTessellator(!1)}static fromCIMLine(t,e,s){const i=t.color,r=t.scaleFactor||1,n=t.isDashed;let o=t.cap;n&&1===o&&(o=2);const a=t.join,l=g(t.width)*r,h=g(t.referenceWidth),c=g(t.miterLimit),u=i&&zt(i)||0;if(!e)return new ls(t.materialKey,e,l,o,a,c,u,0,0,!1,n,t.colorLocked,h,t.zOrder,s,t.effects);const{rect:f,width:d,height:m}=e,_=f.x+I,p=f.y+I,y=_+d,x=p+m,M=it(_,p),w=it(y,x);return new ls(t.materialKey,e,l,o,a,c,u,M,w,!0,n,t.colorLocked,h,t.zOrder,s,t.effects)}static fromSimpleLine(t,e,s){const{color:i}=t,r="esriSLSSolid"!==t.style&&"esriSLSNull"!==t.style,n=rt(t.cap||"round",r),o=nt(t.join||"round");let a=i&&"esriSLSNull"!==t.style&&St(i)||0;"esriSLSNull"===t.style&&(a=0);const l=g(t.width),h=t.miterLimit;if(!e)return new ls(t.materialKey,e,l,n,o,h,a,0,0,!1,r,!1,l,0,s,null);const{rect:c,width:u,height:f}=e,d=c.x+I,m=c.y+I,_=d+u,p=m+f,y=it(d,m),x=it(_,p);return new ls(t.materialKey,e,l,n,o,h,a,y,x,!0,r,!1,l,0,s,null)}static fromPictureLineSymbol(t,e,s,i){return as.error("PictureLineSymbol support does not exist!"),null}}class hs{constructor(){this._resolver=null}isHeld(){return!!this._resolver}acquire(){return this._resolver?this._resolver.promise.then((()=>this.acquire())):(this._resolver=B(),D())}release(){const t=this._resolver;this._resolver=null,t.resolve()}}const cs=l.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),us=new Array;function fs(t,e){const s=t.length;return t.push(null),e.then((e=>t[s]=e)),t}function ds(t){return!!(1&t)}class ms{constructor(t,e){this._idCounter=1,this._templateIdCounter=1,this._idToTemplateGroup=new Map,this._symbolToTemplate=new Map,this._fetchQueue=[],this._idToResolver=new Map,this._cimTemplateCache=new Map,this._cimAnalyses=[],this._lock=new hs,this._fetchResource=t,this._joinOnUTurn=e}get _markerError(){return this._errorTemplates.marker[0]}get _fillError(){return this._errorTemplates.fill[0]}get _lineError(){return this._errorTemplates.line[0]}get _textError(){return this._errorTemplates.line[0]}createTemplateGroup(t,e){this._initErrorTemplates();const s=t.hash;if(this._symbolToTemplate.has(s))return this._symbolToTemplate.get(s);const i=new Array;e&&this._createMeshTemplates(i,e,!0),this._createMeshTemplates(i,t,!1);const r=this._createGroupId("expanded-cim"===t.type);return this._idToTemplateGroup.set(r,i),this._symbolToTemplate.set(s,r),r}getTemplateGroup(t){return this._idToTemplateGroup.has(t)?this._idToTemplateGroup.get(t):us}getDynamicTemplateGroup(t){return this._idToTemplateGroup.has(t)?(ds(t)||cs.error("mapview-template-store",`Id ${t} does not refer to a dynamic template`),this._idToTemplateGroup.get(t)):us}getMosaicItem(t,e){const s=this._createTemplateId(),i=E((t=>this._idToResolver.set(s,t)));return this._fetchQueue.push({symbol:t,id:s,glyphIds:e}),i}finalize(t){return this._fetchQueue.length||this._lock.isHeld()?function(t,e,s){return t.acquire().then((()=>e(s))).then((()=>t.release())).catch((e=>{throw t.release(),e}))}(this._lock,this._fetchAllQueuedResources.bind(this),t):D()}_initErrorTemplates(){this._errorTemplates||(this._errorTemplates={fill:this._createMeshTemplates([],_t(K),!1),marker:this._createMeshTemplates([],_t(W),!1),line:this._createMeshTemplates([],_t(Z),!1)})}_fetchAllQueuedResources(t){if(!this._fetchQueue.length)return D();const e=this._fetchQueue,s=this._cimAnalyses;return this._fetchQueue=[],this._cimAnalyses=[],h(s).then((()=>this._fetchResource(e,t).then((t=>{for(const{id:e,mosaicItem:s}of t)this._idToResolver.get(e)(s),this._idToResolver.delete(e)})))).catch((t=>{X(t)?this._fetchQueue=this._fetchQueue.concat(e):"worker:port-closed"===t.name||cs.error(new o("mapview-template-store","Unable to fetch requested texture resources",t))}))}_createGroupId(t){return this._idCounter++<<1|(t?1:0)}_createTemplateId(){return this._templateIdCounter++}async _createSMS(t){const{spriteMosaicItem:e}=await this.getMosaicItem(t);return Ut(e,cs)?ue.fromSimpleMarker(t,e):this._markerError}async _createPMS(t){const{spriteMosaicItem:e}=await this.getMosaicItem(t);return Ut(e,cs)?ue.fromPictureMarker(t,e):this._markerError}async _createSFS(t,e){const{spriteMosaicItem:s}=await this.getMosaicItem(t);return Ut(s,cs)?os.fromSimpleFill(t,s,e):this._fillError}async _createPFS(t,e){const{spriteMosaicItem:s}=await this.getMosaicItem(t);return Ut(s,cs)?os.fromPictureFill(t,s,e):this._fillError}async _createSLS(t,e){const{spriteMosaicItem:s}=await this.getMosaicItem(t);return Ut(s,cs)?ls.fromSimpleLine(t,s,this._joinOnUTurn):this._lineError}async _createLMS(t){const{spriteMosaicItem:e}=await this.getMosaicItem(t);return Ut(e,cs)?ue.fromLineSymbolMarker(t,e):this._markerError}async _createTS(t){const{glyphMosaicItems:e}=await this.getMosaicItem(t);return he.fromText(t,e)}async _createCIMText(t){const{glyphMosaicItems:e}=await this.getMosaicItem(t.cim,rs(t.text));return t.cim.mosaicHash=t.materialHash,Ut(e,cs)?he.fromCIMText(t,e):this._textError}async _createCIMFill(t){t.cim.mosaicHash=t.materialHash;const{spriteMosaicItem:e}=await this.getMosaicItem(t.cim);return Ut(e,cs)?os.fromCIMFill(t,e):this._fillError}async _createCIMLine(t){t.cim.mosaicHash=t.materialHash;const{spriteMosaicItem:e}=await this.getMosaicItem(t.cim);return Ut(e,cs)?ls.fromCIMLine(t,e,this._joinOnUTurn):this._lineError}async _createCIMMarker(t){t.cim.mosaicHash=t.materialHash;const{spriteMosaicItem:e}=await this.getMosaicItem(t.cim);return Ut(e,cs)?ue.fromCIMMarker(t,e):this._markerError}async _createCIM(t){const e=t.templateHash;if(this._cimTemplateCache.has(e))return this._cimTemplateCache.get(e);let s;switch(t.type){case"marker":s=this._createCIMMarker(t);break;case"line":s=this._createCIMLine(t);break;case"fill":s=this._createCIMFill(t);break;case"text":s=this._createCIMText(t)}return s.then((t=>this._cimTemplateCache.set(e,t))),s}_createDynamicCIM(t){const e=t.templateHash;if(this._cimTemplateCache.has(e))return this._cimTemplateCache.get(e);let s;switch(t.type){case"marker":s=is.fromCIMMarker(t);break;case"line":s=$e.fromCIMLine(t);break;case"fill":s=Xe.fromCIMFill(t);break;case"text":s=ns.fromCIMText(t)}return this._cimTemplateCache.set(e,s),s}_createPrimitiveMeshTemplates(t,e,s){switch(e.type){case"esriSMS":return fs(t,this._createSMS(e));case"esriPMS":return fs(t,this._createPMS(e));case"esriSFS":return fs(t,this._createSFS(e,s));case"line-marker":return fs(t,this._createLMS(e));case"esriPFS":return fs(t,this._createPFS(e,s));case"esriSLS":return fs(t,this._createSLS(e,!1));case"esriTS":return fs(t,this._createTS(e));default:return cs.error("Unable to create mesh template for unknown symbol type {: $ }{symbol.type}"),t}}_createMeshTemplates(t,e,s){if(-1!==e.type.indexOf("3d"))return cs.error("3D symbols are not supported with MapView"),t;if("expanded-cim"===e.type){for(const s of e.layers)"function"==typeof s.materialHash?t.push(this._createDynamicCIM(s)):fs(t,this._createCIM(s));return t}if("composite-symbol"===e.type){for(const i of e.layers)this._createPrimitiveMeshTemplates(t,i,s);return t}return"cim"===e.type||"label"===e.type||"web-style"===e.type?t:this._createPrimitiveMeshTemplates(t,e,s)}}class _s{constructor(t,e){this.data=t,this.stride=e}get vertexCount(){const t=this.stride/4,e=this.data.length/t;return e!==(0|e)&&console.debug("Corrupted stride"),e}transfer(t,e){const s=this.data.buffer();t.vertexCount=this.vertexCount,t.data=s,t.stride=this.stride,e.push(s)}}class ps{constructor(t,e,s=!1){this.geometryType=t,this.indexVector=new Tt(Uint32Array,6*e),this.namedVectors={};const i=ot(t,s);for(const r in i){const t=i[r];let s;switch(t%4){case 0:case 2:s=new Tt(Uint32Array,t*e);break;case 1:case 3:s=new Tt(Uint8Array,t*e)}this.namedVectors[r]=new _s(s,t)}}get(t){return this.namedVectors[t].data}getVector(t){return this.namedVectors[t]}transfer(t,e){const s=this.indexVector.buffer(),i={};e.push(s);for(const r in this.namedVectors){const t=this.namedVectors[r];i[r]={},t.transfer(i[r],e)}t.geometryType=this.geometryType,t.indexBuffer=s,t.namedBuffers=i,this.destroy()}intoBuffers(){const t=Lt.fromVertexVectors(this);return this.destroy(),t}destroy(){this.indexVector=null,this.namedVectors=null}}function ys(t){return t.length-1}function xs(t,e,s=1){const[i,r]=function(t,e){return t[e+1]}(t,e);return Math.sqrt(i*i+r*r)*s}class gs{constructor(t,e,s,i,r){this._segments=t,this._index=e,this._distance=s,this._xStart=i,this._yStart=r,this._done=!1}static create(t){return new gs(t,0,0,t[0][0],t[0][1])}clone(){return new gs(this._segments,this._index,this._distance,this.xStart,this.yStart)}equals(t){return this._index===t._index||t._index===this._index-1&&(0===this._distance||1===t._distance)||t._index===this._index+1&&(1===this._distance||0===t._distance)}leq(t){return this._index<t._index||this._index===t._index&&this._distance<=t._distance}geq(t){return this._index>t._index||this._index===t._index&&this._distance>=t._distance}get _segment(){return this._segments[this._index+1]}get angle(){const t=this.dy,e=(0*t+-1*-this.dx)/(1*this.length);let s=Math.acos(e);return t>0&&(s=2*Math.PI-s),s}get xStart(){return this._xStart}get yStart(){return this._yStart}get x(){return this.xStart+this.distance*this.dx}get y(){return this.yStart+this.distance*this.dy}get dx(){return this._segment[0]}get dy(){return this._segment[1]}get xMidpoint(){return this.xStart+.5*this.dx}get yMidpoint(){return this.yStart+.5*this.dy}get xEnd(){return this.xStart+this.dx}get yEnd(){return this.yStart+this.dy}get length(){const{dx:t,dy:e}=this;return Math.sqrt(t*t+e*e)}get remainingLength(){return this.length*(1-this._distance)}get backwardLength(){return this.length*this._distance}get distance(){return this._distance}get done(){return this._done}hasPrev(){return this._index-1>=0}hasNext(){return this._index+1<ys(this._segments)}next(){return this.hasNext()?(this._xStart+=this.dx,this._yStart+=this.dy,this._distance=0,this._index+=1,this):null}prev(){return this.hasPrev()?(this._index-=1,this._xStart-=this.dx,this._yStart-=this.dy,this._distance=1,this):(this._done=!0,null)}_seekBackwards(t,e){const s=this.backwardLength;if(t<=s)return this._distance=(s-t)/this.length,this;let i=this.backwardLength;for(;this.prev();){if(i+this.length>t)return this._seekBackwards(t-i);i+=this.length}return this._distance=0,e?this:null}seek(t,e=!1){if(t<0)return this._seekBackwards(Math.abs(t),e);if(t<=this.remainingLength)return this._distance=(this.backwardLength+t)/this.length,this;let s=this.remainingLength;for(;this.next();){if(s+this.length>t)return this.seek(t-s,e);s+=this.length}return this._distance=1,e?this:null}}function Ms(t,e,s){const i=function(t){let e=0;for(let s=0;s<ys(t);s++)e+=xs(t,s);return e}(t),r=gs.create(t),n=i/2,o=(i-e)/2,a=Math.floor(o/e),l=n-a*e;r.seek(l);for(let h=-a;h<=a;h++)r.x<512&&r.x>=0&&r.y<512&&r.y>=0&&s(r.clone(),h,n+h*e,i),r.seek(e)}function ws(t,e){const s=1e-6;if(e<=0)return;const i=t.length;if(i<3)return;const r=[];let n=0;r.push(0);for(let u=1;u<i;u++)n+=Gt(t[u],t[u-1]),r.push(n);e=Math.min(e,.2*n);const o=[];o.push(t[0][0]),o.push(t[0][1]);const a=t[i-1][0],l=t[i-1][1],h=Vt([0,0],t[0],t[1]);Bt(h),t[0][0]+=e*h[0],t[0][1]+=e*h[1],Vt(h,t[i-1],t[i-2]),Bt(h),t[i-1][0]+=e*h[0],t[i-1][1]+=e*h[1];for(let u=1;u<i;u++)r[u]+=e;r[i-1]+=e;const c=.5*e;for(let u=1;u<i-1;u++){let n=0,a=0,l=0;for(let i=u-1;i>=0&&!(r[i+1]<r[u]-c);i--){const o=c+r[i+1]-r[u],h=r[i+1]-r[i],f=r[u]-r[i]<c?1:o/h;if(Math.abs(f)<s)break;const d=f*f,m=f*o-.5*d*h,_=f*h/e,p=t[i+1],y=t[i][0]-p[0],x=t[i][1]-p[1];n+=_/m*(p[0]*f*o+.5*d*(o*y-h*p[0])-d*f*h*y/3),a+=_/m*(p[1]*f*o+.5*d*(o*x-h*p[1])-d*f*h*x/3),l+=_}for(let o=u+1;o<i&&!(r[o-1]>r[u]+c);o++){const i=c-r[o-1]+r[u],h=r[o]-r[o-1],f=r[o]-r[u]<c?1:i/h;if(Math.abs(f)<s)break;const d=f*f,m=f*i-.5*d*h,_=f*h/e,p=t[o-1],y=t[o][0]-p[0],x=t[o][1]-p[1];n+=_/m*(p[0]*f*i+.5*d*(i*y-h*p[0])-d*f*h*y/3),a+=_/m*(p[1]*f*i+.5*d*(i*x-h*p[1])-d*f*h*x/3),l+=_}o.push(n/l),o.push(a/l)}o.push(a),o.push(l);for(let u=0,f=0;u<i;u++)t[u][0]=o[f++],t[u][1]=o[f++]}const bs=l.getLogger("esri.views.2d.engine.webgl.WGLLabelTemplate"),vs=function(t){const e=new Map;return t=>(e.has(t)||e.set(t,(t=>{let e=0;if(0===t)return 1/0;for(;!(t%2);)e++,t/=2;return e})(t)),e.get(t))}(),Ts=t=>Math.floor(127*t+127),Ls=t=>Math.floor(10*t),Cs=t=>Math.round(t*(254/360)),Ps=(t,e)=>it(Math.round(8*t),Math.round(8*e));class Ss extends he{constructor(t,e,s,i){super(t,s.font.size,s.haloSize||0,s.color&&St(s.color)||0,s.haloColor&&St(s.haloColor)||0,s.horizontalAlignment,s.verticalAlignment,dt(e.labelPlacement)?1:0,s.font.decoration,!1,s.angle||0,s.xoffset,s.yoffset,s.lineWidth,s.lineHeight,null,null),this._outLineLabelAngle=0,this._refPlacementPadding=0,this._refPlacementDirX=0,this._refPlacementDirY=0,this._refOffsetX=0,this._refOffsetY=0,this.geometryType=et.LABEL;const r=function(t,e){const s=!!t.minScale&&e.scaleToZoom(t.minScale)||0;return H(s,0,25.5)}(e,i),n=function(t,e){const s=!!t.maxScale&&e.scaleToZoom(t.maxScale)||255;return H(s,0,25.5)}(e,i),o=e.labelPlacement,[a,l]=wt(o);this._xAlignD=a,this._yAlignD=l,this._minZoom=r,this._maxZoom=n,this._refPlacementPadding=g(s.haloSize)+j;const h=mt.load(t);h.sdf=!0,this._materialKey=h.data}static fromLabelClass(t,e){if("center-along"===t.labelPlacement){const e=t.symbol;e.xoffset=0,e.yoffset=0,e.angle=0,e.font.decoration="none"}return new Ss(t.materialKey,t,t.symbol,e)}get _shapedBox(){return x(this._shapingInfo).bounds}bindReferenceTemplate(t){let e=bt(this._xAlignD),s=vt(this._yAlignD);if(this._refOffsetX=0,this._refOffsetY=0,y(t))return void(this._refSymbolAndPlacementOffset=st(0,0,Ts(e),Ts(s)));if("circle"===t.boundsType&&(e||s)){const t=Math.sqrt(e*e+s*s);e/=t,s/=t}const i=Math.max(t.height,t.width),r=4*this._refPlacementPadding;this._refSymbolAndPlacementOffset=st(r,i,Ts(e),Ts(s)),this._referenceSize=i,this._refPlacementDirX=e,this._refPlacementDirY=s,this._refOffsetX=t.xOffset,this._refOffsetY=t.yOffset}writeMesh(t,e,s,i,r,n){if(y(this._shapingInfo))return;const a=new Array,l=this._shapingInfo,h="esriGeometryPolygon"===s.geometryType?s.readLegacyCentroid():s.readLegacyGeometry();if(h){switch(this.current={out:t,outVecs:e,outMetrics:a,inId:r,inShaping:l,zoomLevel:n},i){case"esriGeometryPolyline":this._placeLineLabels(h);break;case"esriGeometryPoint":case"esriGeometryPolygon":this._placePointLabels(h);break;default:((t,e="mapview-labeling")=>{bs.error(new o(e,t))})("mapview-labeling",`Geometry of type ${i} is not supported`)}t.writeMetrics(this.current.outMetrics)}}_isVisible(t,e){const s=Ls(this.current.zoomLevel);return Ls(t)<=s&&s<=Ls(e)}_placePointLabels(t){const{out:e,outVecs:s,outMetrics:i,inId:r}=this.current;this._writeGlyphs(e,s,r,t,i)}_placeLineLabels(t){const e=function(t,e){const s=e;for(let i=0;i<t.length;i++){let e=t[i];const r=[];r.push(e[0]);for(let t=1;t<e.length;t++){let[s,i]=r[t-1];s+=e[t][0],i+=e[t][1],r.push([s,i])}ws(r,s);const n=[];n.push(r[0]);for(let t=1;t<r.length;t++){const[e,s]=r[t-1],[i,o]=r[t],a=Math.round(i-e),l=Math.round(o-s);n.push([a,l])}t[i]=n,e=n}return t}(t.paths,this.current.inShaping.bounds.width),s=this._placeSubdivGlyphs.bind(this),i=(this._shapedBox.width+128)/4;for(const r of e)Ms(r,i,s)}_placeSubdivGlyphs(t,e,s,i){const r=vs(e),n=this._shapedBox.width/4,o=Math.min(s,i-s),a=U(o/(4+n/2)),l=0===e?a:Math.min(r,a),h=Math.max(this._minZoom,this.current.zoomLevel+2-l),c=this.current.zoomLevel-h,u=this._shapedBox.width/2*Math.pow(2,c);this.current.inShaping.isMultiline?0===e&&this._placeStraight(t,h):this._placeCurved(t,h,u)}_placeStraight(t,e){const{out:s,outVecs:i,outMetrics:r,inId:n}=this.current;this._writeGlyphs(s,i,n,t,r,e)}_placeCurved(t,e,s){const i={from:this.current.out.currentDisplayRecordCount(),count:-1},r=new Ct(this.current.inId,i,t.x,t.y,e),n=t.clone(),o=t.angle*(180/Math.PI)%360,a=(t.angle*(180/Math.PI)+180)%360;this._outLineLabelAngle=Cs(o),this._placeFirst(n,r,e,1),this._placeBack(t,n,r,e,s,1),this._placeForward(t,n,r,e,s,1),this._outLineLabelAngle=Cs(a),this._placeFirst(n,r,e,0),this._placeBack(t,n,r,e,s,0),this._placeForward(t,n,r,e,s,0),r.range.count=this.current.out.currentDisplayRecordCount()-r.range.from,r.bounds&&this.current.outMetrics.push(r)}_placeBack(t,e,s,i,r,n){const o=t.clone();let a=t.backwardLength+0;for(;o.prev()&&!(a>=r);)this._placeOnSegment(o,e,s,a,i,-1,n),a+=o.length+0}_placeForward(t,e,s,i,r,n){const o=t.clone();let a=t.remainingLength+0;for(;o.next()&&!(a>=r);)this._placeOnSegment(o,e,s,a,i,1,n),a+=o.length+0}_placeFirst(t,e,s,i){const r=t,n=this.current.inShaping,o=n.glyphs,a=this.current.zoomLevel,{out:l,outVecs:h,inId:c}=this.current,u=Ps(r.x,r.y);for(const f of o){const r=f.x>n.bounds.x?i:1-i,o=r*t.remainingLength+(1-r)*t.backwardLength,d=Math.abs(f.x+f.width/2-n.bounds.x),m=Math.max(0,a+U(d/(o+0))),_=Math.max(s,m);f.maxZoom=25,f.angle=t.angle+(1-i)*Math.PI,f.minZoom=_,this._writeGlyph(l,h,f,c,u),i&&this._isVisible(f.minZoom,f.maxZoom)&&e.add(f.bounds,0,0)}}_placeOnSegment(t,e,s,i,r,n,o){const a=this.current.inShaping.glyphs,{out:l,outVecs:h,inId:c}=this.current,u=this.current.inShaping,f=this.current.zoomLevel,d=t.dx/t.length,m=t.dy/t.length,_={x:t.x+i*-n*d,y:t.y+i*-n*m},p=Ps(_.x,_.y);for(const y of a){const a=y.x>u.bounds.x?o:1-o;if(!(a&&1===n||!a&&-1===n))continue;const d=Math.abs(y.x+y.width/2-u.bounds.x),m=Math.max(0,f+U(d/i)-.1),_=Math.max(r,f+U(d/(i+t.length+0)));0!==m&&(y.angle=t.angle+(1-o)*Math.PI,y.minZoom=_,y.maxZoom=m,this._writeGlyph(l,h,y,c,p),o&&this._isVisible(y.minZoom,y.maxZoom)&&s.add(y.bounds,t.x-e.x,t.y-e.y))}}_writeGlyphs(t,e,s,i,r,n=this._minZoom){const o=this._shapingInfo;if(y(o))return;if(i.x<0||i.x>=512||i.y<0||i.y>=512)return;const a=t.currentDisplayRecordCount(),l=Ps(i.x+this._refOffsetX,i.y-this._refOffsetY),h=new Ct(s,{from:a,count:-1},i.x+this._refOffsetX,i.y-this._refOffsetY,n);for(const m of o.glyphs)m.minZoom=n,m.maxZoom=this._maxZoom,this._writeGlyph(t,e,m,s,l);h.range.count=t.currentDisplayRecordCount()-h.range.from,h.bounds=o.boundsT;const c=mt.load(this._materialKey),u=this._refPlacementDirX,f=this._refPlacementDirY,d=c.vvSizeFieldStops||c.vvSizeMinMaxValue||c.vvSizeScaleStops||c.vvSizeUnitValue;h.setPlacementOffset(d,this._referenceSize,this._refPlacementPadding,u,f),r.push(h)}_writeGlyph(t,e,s,i,r){const n=lt.load(this._materialKey);n.textureBinding=s.textureBinding;const o=e.indexVector.length,a=e.getVector("geometry").vertexCount,l=this._writeIndices(e),h=this._writeVertex(e,i,r,s);t.writeDisplayRecord(this.geometryType,n.data,a,h,o,l)}_writeVertexCommon(t,e,s,i){const r=this._color,n=this._haloColor,o=st(0,0,this._size,this._haloSize),a=Math.max(i.minZoom,this._minZoom),l=Math.min(i.maxZoom,this._maxZoom),h=st(Ls(a),Ls(l),this._outLineLabelAngle,0);t.push(s),t.push(e),t.push(r),t.push(n),t.push(o),t.push(this._refSymbolAndPlacementOffset),t.push(h)}}class zs{constructor(t,e,s){this._isDD=!1,this._geometryType=t,this._idField=e,this._templateStore=s}update(t,e){this._isDD="simple"===t.mesh.matcher.type&&t.mesh.matcher.isDotDensity,m(t.mesh.labels)&&this._setLabelTemplates(t.mesh.labels,e)}_setLabelTemplates(t,e){this._labelTemplates=t.map((t=>Ss.fromLabelClass(t,e)))}get templates(){return this._templateStore}createMeshData(t){const e=new Array(5),s=this._labelTemplates&&this._labelTemplates.length>0,i="esriGeometryPolyline"===this._geometryType?N:q;return e[et.MARKER]=new ps(et.MARKER,4*t),e[et.FILL]=new ps(et.FILL,t,this._isDD),e[et.LINE]=new ps(et.LINE,t),e[et.TEXT]=new ps(et.TEXT,4*t),e[et.LABEL]=new ps(et.LABEL,s?4*i:0),new Pt(e,{features:t,records:t,metrics:0})}async analyze(t,e,s,i,r){if(Y(r))return;let n;"dictionary"===e.type&&(n=await e.analyze(this._idField,t.copy(),s,i,r));let o=0;for(;t.next();){let r;if(r=n?n[o++]:e.match(this._idField,t,this._geometryType,s,i),t.setGroupId(r),ds(r)){const e=this._templateStore.getDynamicTemplateGroup(r);for(const r of e)r&&r.analyze&&r.analyze(this._templateStore,t,s,i)}}return this._templateStore.finalize(r)}async analyzeGraphics(t,e,s,i,r){if(Y(r))return;const n=t.getCursor();for(e&&await e.analyze(this._idField,n.copy(),s,i,r);n.next();){let t=n.getGroupId();if(null!=t&&-1!==t||(t=e.match(this._idField,n,n.geometryType,s,i),n.setGroupId(t)),ds(t)){const e=this._templateStore.getDynamicTemplateGroup(t);for(const t of e)t&&t.analyze&&t.analyze(this._templateStore,n,s,i)}n.setGroupId(t)}return this._templateStore.finalize(r)}writeGraphic(t,e){const s=e.getGroupId(),i=e.getDisplayId(),r=this._templateStore.getTemplateGroup(s),n=e.geometryType;if(null!=i){if(ds(s))for(const t of r)t.bindFeature(e,null,null);if(r){t.writeDisplayObject(i,e.readGraphic().insertAfter);for(const s of r){if(!s)continue;const r=t.get(s.geometryType);s.writeMesh(t,r,e,n,i)}}}}writeCursor(t,e,s,i,r,n){const o=e.getGroupId(),a=e.getDisplayId(),l=this._templateStore.getTemplateGroup(o);if(null==a)return;if(!l)return;if(t.writeDisplayObject(a,0),ds(o))for(const c of l)c.bindFeature(e,s,i);for(const c of l){const s=t.get(c.geometryType);!c.needsPixelBuffer&&e.hasFilter()||c.writeMesh(t,s,e,this._geometryType,a)}const h=t.hasDisplayRecords();if(m(n)&&h){const s=n&&this._findLabelRef(l);this._writeLabels(t,e,a,n,s,r)}t.endDisplayObject()}_findLabelRef(t){for(const e of t)if(e instanceof ue)return e;return null}_writeLabels(t,e,s,i,r,n){for(const o of i)if(m(o)&&o){const{glyphs:i,rtl:a,index:l}=o,h=this._labelTemplates[l],c=t.get(h.geometryType);h.bindReferenceTemplate(r),h.bindTextInfo(i,a),h.writeMesh(t,c,e,this._geometryType,s,n)}}}export{ms as L,Ut as e,zs as m,Qt as n,re as s,rs as t};
